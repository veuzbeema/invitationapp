{% extends 'base/base.html' %}
{% load static %}

{% block title %}Export Jobs{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-gray-800">Export Jobs</h1>
        <button onclick="window.location.reload()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-md transition duration-200">
            Refresh
        </button>
    </div>
    
    <div class="bg-white shadow-lg rounded-lg overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job ID</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Format</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Created</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody id="jobs-table-body" class="bg-white divide-y divide-gray-200">
                    {% for job in jobs %}
                    <tr class="job-row hover:bg-gray-50 transition duration-150" data-job-id="{{ job.id }}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ job.id }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ job.export_format|upper }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="status-text {{ job.status }}-status px-2 py-1 rounded-full text-xs font-medium">
                                {{ job.status|capfirst }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="progress bg-blue-600 h-2.5 rounded-full" style="width: {{ job.progress }}%"></div>
                            </div>
                            <span class="progress-text text-xs text-gray-600 mt-1 block">{{ job.progress }}%</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">{{ job.created_at|date:"Y-m-d H:i" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {% if job.status == 'completed' and job.file %}
                                <a href="/exports/download/{{ job.id }}/" class="download-btn bg-blue-600 hover:bg-blue-700 text-white font-medium py-1 px-3 rounded-md transition duration-200">Download</a>
                            {% elif job.status == 'failed' %}
                                <span class="text-red-600 text-xs">Failed: {{ job.error_message|default:"Unknown error" }}</span>
                            {% else %}
                                <span class="text-gray-500 text-xs">Processing...</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No export jobs found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

<style>
    .pending-status {
        background-color: #e5e7eb;
        color: #4b5563;
    }
    .processing-status {
        background-color: #dbeafe;
        color: #1d4ed8;
    }
    .completed-status {
        background-color: #d1fae5;
        color: #047857;
    }
    .failed-status {
        background-color: #fee2e2;
        color: #b91c1c;
    }
    .progress {
        transition: width 0.3s ease-in-out;
    }
    .progress-text {
        font-size: 0.75rem;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const jobRows = document.querySelectorAll('.job-row');
    
    function updateJobStatus(jobRow, jobId) {
        fetch(`/exports/status/${jobId}/`)
            .then(response => response.json())
            .then(data => {
                const statusCell = jobRow.querySelector('.status-text');
                const actionCell = jobRow.cells[jobRow.cells.length - 1];
                const progressBar = jobRow.querySelector('.progress');
                const progressText = jobRow.querySelector('.progress-text');
                
                // Update status
                statusCell.classList.remove('pending-status', 'processing-status', 'completed-status', 'failed-status');
                statusCell.classList.add(`${data.job_status}-status`);
                statusCell.textContent = data.job_status.charAt(0).toUpperCase() + data.job_status.slice(1);
                
                // Update progress
                if (progressBar) progressBar.style.width = `${data.progress}%`;
                if (progressText) progressText.textContent = `${data.progress}%`;
                
                // Update actions
                if (data.job_status === 'completed' && data.download_url) {
                    actionCell.innerHTML = `<a href="${data.download_url}" class="download-btn bg-blue-600 hover:bg-blue-700 text-white font-medium py-1 px-3 rounded-md transition duration-200">Download</a>`;
                    if (progressBar) {
                        progressBar.style.width = '100%';
                        progressText.textContent = '100%';
                       
                    }
                } else if (data.job_status === 'failed') {
                    actionCell.innerHTML = `<span class="text-red-600 text-xs">Failed: ${data.error_message || 'Unknown error'}</span>`;
                    if (progressBar) {
                        progressBar.parentElement.parentElement.innerHTML = '<span class="text-red-600 text-xs">Failed</span>';
                    }
                }
                
                // Continue polling if not completed or failed
                if (data.job_status !== 'completed' && data.job_status !== 'failed') {
                    setTimeout(() => updateJobStatus(jobRow, jobId), 3000);
                }
            })
            .catch(error => console.error('Error fetching job status:', error));
    }
    
    // Start polling for each job that's not completed or failed
    jobRows.forEach(row => {
            const status = row.querySelector('.status-text').textContent.toLowerCase();
            if (['pending', 'processing'].includes(status)) {
                const jobId = row.dataset.jobId;
                updateJobStatus(row, jobId);  // Start polling
            }
        });
});
</script>
{% endblock %}