{% extends 'base/base.html' %}
{% load static %}

{% block title %}Visitor Invitation{% endblock %}

{% block content %}
  <!-- Main Content -->
            <!-- Page Header -->
            <div class="page-header animate-fade-in">
                <h1 class="page-title">Visitor Invitation</h1>
                <p class="page-description">
                    Send complimentary Visitor Pass invitations for GITEX GLOBAL 2025 and Expand North Star 2025.
                </p>
            </div>

        <!-- Ticket Type Stats Cards -->
<!-- Ticket Type Stats Cards -->
  <div class="row mb-4 animate-fade-in">
    {% for ticket_type in ticket_types %}
    <div class="col-md-4 mb-2">
      <div class="stat-card">
        <div class="stat-icon {{ ticket_type.color_class }}">
          <i class="fas fa-ticket-alt"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value" data-count="{{ ticket_type.available }}">{{ ticket_type.available }} Available</div>
          <div class="stat-label">{{ ticket_type.name|title }} ({{ ticket_type.used }}/{{ ticket_type.total }})</div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <p class="text-muted">No ticket types available.</p>
    </div>
    {% endfor %}
  </div>

            <!-- Action Cards -->
            <div class="row mb-3 animate-fade-in">
                <div class="col-md-4 mb-2">
                    <div class="action-card" data-bs-toggle="modal" data-bs-target="#personalizedModal">
                        <div class="d-flex align-items-center">
                            <div class="action-card-icon me-3">
                                <i class="fas fa-envelope-open-text"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5>Send Personalized Invitation</h5>
                                <p class="text-muted mb-2">Send a personalized invitation to a guest</p>
                                <button class="btn btn-sm btn-primary">
                                    <i class="fas fa-paper-plane me-1"></i>Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="action-card" data-bs-toggle="modal" data-bs-target="#bulkPersonalizedModal">
                        <div class="d-flex align-items-center">
                            <div class="action-card-icon me-3">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5>Send Bulk Personalized Invitation</h5>
                                <p class="text-muted mb-2">Upload CSV and send to multiple guests</p>
                                <button class="btn btn-sm btn-success">
                                    <i class="fas fa-file-upload me-1"></i>Upload
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="action-card" data-bs-toggle="modal" data-bs-target="#generateLinkModal">
                        <div class="d-flex align-items-center">
                            <div class="action-card-icon me-3">
                                <i class="fas fa-link"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5>Generate Invitation Link</h5>
                                <p class="text-muted mb-2">Generate and share generic link</p>
                                <button class="btn btn-sm btn-primary">
                                    <i class="fas fa-share-alt me-1"></i>Generate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-3 animate-fade-in">
                <div class="col-lg-3 col-md-6 mb-2">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" data-count="{{ allocated_invitations }}"></div>
                            <div class="stat-label">Allocated Invitations</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-2">
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-share"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" data-count="{{ generated_invitations }}">0</div>
                            <div class="stat-label">Generated Invitations</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-2">
                    <div class="stat-card">
                        <div class="stat-icon info">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" data-count="{{ remaining_invitations }}">0</div>
                            <div class="stat-label">Remaining Invitations</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-2">
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" data-count="{{ registered_visitor }}">{{ registered_visitor }}</div>
                            <div class="stat-label">Registered Visitors</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Section -->
            <!-- <div class="filter-section animate-fade-in">
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label small text-muted">Keyword</label>
                        <input type="text" class="form-control form-control-sm" placeholder="Search..." id="searchKeyword">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">Status</label>
                        <select class="form-select form-select-sm select2" id="filterStatus" style="border: 1px solid #dee2e6;">
                            <option value="">All</option>
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">Type</label>
                        <select class="form-select form-select-sm select2" id="filterType" style="border: 1px solid #dee2e6;">
                            <option value="">All</option>
                            <option value="link">Link</option>
                            <option value="personal">Personal</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">Expiry</label>
                        <input type="date" class="form-control form-control-sm" id="filterDate">
                    </div>
                    <div class="col-md-3 d-flex align-items-end gap-1">
                        <button class="btn btn-sm btn-primary" id="searchBtn">
                            <i class="fas fa-search"></i> Search
                        </button>
                        <button class="btn btn-sm btn-secondary" id="resetBtn">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button class="btn btn-sm btn-success ms-auto" id="exportBtn">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
            </div> -->

            <!-- Table Section -->
            <div class="table-wrapper animate-fade-in">
                <div class="table-actions">
                    <h5 class="mb-0">Invitation List</h5>
                    <div class="action-btn-group">
                        <button class="btn btn-sm btn-outline-primary" id="refreshTable">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="columnToggle">
                            <i class="fas fa-columns"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Bulk Actions Bar -->
                <div class="bulk-actions-bar" id="bulkActionsBar">
                    <div class="bulk-actions-info">
                        <i class="fas fa-check-circle text-primary me-2"></i>
                        <span id="selectedCount">0</span> items selected
                    </div>
                    <div class="bulk-actions-buttons">
                        <button class="btn btn-sm btn-primary" id="bulkSendBtn">
                            <i class="fas fa-paper-plane me-1"></i>Send Invites
                        </button>
                        <button class="btn btn-sm btn-success" id="bulkActivateBtn">
                            <i class="fas fa-check me-1"></i>Activate
                        </button>
                        <button class="btn btn-sm btn-warning" id="bulkDeactivateBtn">
                            <i class="fas fa-pause me-1"></i>Deactivate
                        </button>
                        <button class="btn btn-sm btn-info" id="bulkExportBtn">
                            <i class="fas fa-download me-1"></i>Export Selected
                        </button>
                        <button class="btn btn-sm btn-danger" id="bulkDeleteBtn">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                        <button class="btn btn-sm btn-secondary" id="clearSelectionBtn">
                            <i class="fas fa-times me-1"></i>Clear
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover" id="invitationTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" class="table-checkbox" id="selectAll">
                                </th>
                                <th>Link Title / Full Name</th>
                                <th>Email Address</th>
                                <th>Invite Type</th>
                                <th>Expiry Date</th>
                                <th>Link Limit</th>
                                <th>Registered</th>
                                <th>Invitation Link</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

{% endblock %}


{% block modal_block %}
<!-- Generate Link Modal -->
    <div class="modal fade" id="generateLinkModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-link text-primary me-2"></i>Create Private Invite Link
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="generateLinkForm">
                        <div class="mb-3">
                            <label class="form-label">Invitation Link Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="linkTitle" required>
                            <small class="text-muted">Give your invitation link a descriptive title</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Expire Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="expireDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">How many invitation links do you need? <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="linkCount" min="1" max="1000" required>
                            <small class="text-muted">Maximum 1000 links per batch</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">How many times each link can be used? <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="linkLimit" min="1" max="100" required>
                            <small class="text-muted">Maximum 100 uses per link</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitLinkBtn">
                        <i class="fas fa-check me-2"></i>Generate Link
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Personalized Invitation Modal -->
    <div class="modal fade" id="personalizedModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-envelope text-primary me-2"></i>Send Personalized Invitation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="personalizedForm">
                        <div class="mb-3">
                            <label class="form-label">Guest Full Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="guestName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Guest Email Address <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="guestEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ticket Type <span class="text-danger">*</span></label>
                            <select class="form-select select2-modal" id="ticketType" required>
                                <option value="">Select Ticket Type</option>
                                <option value="visitor">Visitor</option>
                                <option value="vip">VIP</option>
                                <option value="gold">Gold</option>
                                <option value="platinum">Platinum</option>
                                <option value="exhibitor">Exhibitor</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="companyName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Personal Message</label>
                            <textarea class="form-control" id="personalMessage" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Expire Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="personalExpireDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="sendInviteBtn">
                        <i class="fas fa-paper-plane me-2"></i>Send Invitation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Personalized Invitation Modal -->
    <div class="modal fade" id="bulkPersonalizedModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-users text-success me-2"></i>Send Bulk Personalized Invitations
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bulkPersonalizedForm">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Instructions:</strong> Upload a CSV file with columns: Full Name, Email, Ticket Type, Company Name (optional), Personal Message (optional)
                            <br><small class="mt-1 d-block">Ticket Type options: visitor, vip, gold, platinum, exhibitor</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Upload CSV File <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="bulkCsvFile" accept=".csv" required>
                            <small class="text-muted">Maximum file size: 5MB</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Default Personal Message</label>
                            <textarea class="form-control" id="bulkPersonalMessage" rows="3" placeholder="This message will be added to all invitations..."></textarea>
                            <small class="text-muted">Optional: Add a message that applies to all recipients</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Expire Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="bulkExpireDate" required>
                        </div>

                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="downloadTemplateBtn">
                                <i class="fas fa-download me-1"></i>Download CSV Template
                            </button>
                        </div>

                        <!-- Preview Section -->
                        <div id="csvPreviewSection" style="display: none;">
                            <hr>
                            <h6 class="mb-3">
                                <i class="fas fa-eye me-2"></i>CSV Preview
                                <div class="float-end">
                                    <button type="button" class="btn btn-sm btn-success me-2" id="addManualRowBtn">
                                        <i class="fas fa-plus me-1"></i>Add Row
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="clearPreviewBtn">
                                        <i class="fas fa-trash me-1"></i>Clear All
                                    </button>
                                </div>
                            </h6>
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-bordered" id="csvPreviewTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>#</th>
                                            <th>Full Name</th>
                                            <th>Email</th>
                                            <th>Ticket Type</th>
                                            <th>Company</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="csvPreviewBody">
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-2">
                                <span class="badge bg-success" id="validRowsCount">0 Valid</span>
                                <span class="badge bg-danger" id="invalidRowsCount">0 Invalid</span>
                                <span class="badge bg-info" id="totalRowsCount">0 Total</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="sendBulkInviteBtn" disabled>
                        <i class="fas fa-paper-plane me-2"></i>Send Bulk Invitations
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Edit Invitation Modal -->
<div class="modal fade" id="editInvitationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-warning me-2"></i>Edit Invitation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editInvitationForm">
                    <input type="hidden" id="editInvitationId">
                    <div class="mb-3">
                        <label class="form-label">Guest Full Name / Link Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editGuestName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Guest Email Address</label>
                        <input type="email" class="form-control" id="editGuestEmail" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ticket Type <span class="text-danger">*</span></label>
                        <select class="form-select select2-modal" id="editTicketType" required>
                            <option value="">Select Ticket Type</option>
                            <option value="visitor">Visitor</option>
                            <option value="vip">VIP</option>
                            <option value="gold">Gold</option>
                            <option value="platinum">Platinum</option>
                            <option value="exhibitor">Exhibitor</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="editCompanyName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Personal Message</label>
                        <textarea class="form-control" id="editPersonalMessage" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Expire Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="editExpireDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Link Limit <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="editLinkLimit" min="1" max="100" required>
                        <small class="text-muted">Maximum 100 uses per link</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status <span class="text-danger">*</span></label>
                        <select class="form-select select2-modal" id="editStatus" required>
                            <option value="active">Active</option>
                            <option value="deactivated">Deactivated</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="saveEditBtn">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block extra_scripts %} 
 <script>
        document.addEventListener('DOMContentLoaded', function() {
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('personalExpireDate').setAttribute('min', today);

            console.log('Today\'s date set to:', today);
        });
        $(document).ready(function() {
            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%'
            });

            // Initialize Select2 for modal (delayed to ensure modal is rendered)
            $('#personalizedModal, #generateLinkModal, #bulkPersonalizedModal').on('shown.bs.modal', function () {
                $('.select2-modal').select2({
                    theme: 'bootstrap-5',
                    width: '100%',
                    dropdownParent: $(this)
                });
            });

            // Clear bulk modal on close
            $('#bulkPersonalizedModal').on('hidden.bs.modal', function () {
                $('#bulkPersonalizedForm')[0].reset();
                $('#csvPreviewSection').hide();
                $('#csvPreviewBody').empty();
                csvData = [];
                $('#sendBulkInviteBtn').prop('disabled', true);
                $('#bulkCsvFile').val('');
            });

            // CSV File Upload Handler
            let csvData = [];
            $('#bulkCsvFile').on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        Swal.fire('Error', 'File size exceeds 5MB limit', 'error');
                        $(this).val('');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const text = e.target.result;
                        parseCSV(text);
                    };
                    reader.readAsText(file);
                }
            });

            // Parse CSV and show preview
            function parseCSV(text) {
                const lines = text.split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                csvData = [];
                
                const validTicketTypes = ['visitor', 'vip', 'gold', 'platinum', 'exhibitor'];
                let validCount = 0;
                let invalidCount = 0;

                $('#csvPreviewBody').empty();

                for (let i = 1; i < lines.length; i++) {
                    if (!lines[i].trim()) continue;

                    const values = lines[i].split(',').map(v => v.trim());
                    const row = {
                        index: i,
                        name: values[0] || '',
                        email: values[1] || '',
                        ticketType: values[2] ? values[2].toLowerCase() : '',
                        company: values[3] || '',
                        message: values[4] || ''
                    };

                    csvData.push(row);
                    addPreviewRow(row, validTicketTypes);
                }

                updateValidationCounts();
            }

            // Add preview row with editable ticket type and delete button
            function addPreviewRow(row, validTicketTypes) {
                const hasValidTicketType = validTicketTypes.includes(row.ticketType);
                const hasValidEmail = row.email && validateEmail(row.email);
                const isValid = row.name && hasValidEmail && hasValidTicketType;

                const statusBadge = isValid 
                    ? '<span class="badge bg-success">Valid</span>' 
                    : '<span class="badge bg-danger">Invalid</span>';

                const ticketTypeSelect = `
                    <select class="form-select form-select-sm ticket-type-select" data-index="${row.index}" style="font-size: 11px; border: 1px solid #ced4da; padding: 4px 8px; background-color: white;">
                        <option value="">Select Type</option>
                        <option value="visitor" ${row.ticketType === 'visitor' ? 'selected' : ''}>Visitor</option>
                        <option value="vip" ${row.ticketType === 'vip' ? 'selected' : ''}>VIP</option>
                        <option value="gold" ${row.ticketType === 'gold' ? 'selected' : ''}>Gold</option>
                        <option value="platinum" ${row.ticketType === 'platinum' ? 'selected' : ''}>Platinum</option>
                        <option value="exhibitor" ${row.ticketType === 'exhibitor' ? 'selected' : ''}>Exhibitor</option>
                    </select>
                `;

                const nameInput = `<input type="text" class="form-control form-control-sm editable-field" data-index="${row.index}" data-field="name" value="${row.name}" style="font-size: 11px; border: 1px solid #ced4da; padding: 4px 8px;">`;
                const emailInput = `<input type="email" class="form-control form-control-sm editable-field" data-index="${row.index}" data-field="email" value="${row.email}" style="font-size: 11px; border: 1px solid #ced4da; padding: 4px 8px;">`;
                const companyInput = `<input type="text" class="form-control form-control-sm editable-field" data-index="${row.index}" data-field="company" value="${row.company}" style="font-size: 11px; border: 1px solid #ced4da; padding: 4px 8px;">`;

                const deleteBtn = `
                    <button class="btn btn-sm btn-danger delete-row-btn" data-index="${row.index}" style="font-size: 10px; padding: 2px 6px;">
                        <i class="fas fa-trash"></i>
                    </button>
                `;

                $('#csvPreviewBody').append(`
                    <tr data-index="${row.index}" class="${isValid ? '' : 'table-danger'}">
                        <td>${row.index}</td>
                        <td>${nameInput}</td>
                        <td>${emailInput}</td>
                        <td>${ticketTypeSelect}</td>
                        <td>${companyInput}</td>
                        <td>${statusBadge}</td>
                        <td class="text-center">${deleteBtn}</td>
                    </tr>
                `);
            }

            // Update validation counts
            function updateValidationCounts() {
                const validTicketTypes = ['visitor', 'vip', 'gold', 'platinum', 'exhibitor'];
                let validCount = 0;
                let invalidCount = 0;

                csvData.forEach(row => {
                    const hasValidTicketType = validTicketTypes.includes(row.ticketType);
                    const hasValidEmail = row.email && validateEmail(row.email);
                    const isValid = row.name && hasValidEmail && hasValidTicketType;
                    
                    if (isValid) validCount++;
                    else invalidCount++;
                });

                $('#csvPreviewSection').show();
                $('#validRowsCount').text(`${validCount} Valid`);
                $('#invalidRowsCount').text(`${invalidCount} Invalid`);
                $('#totalRowsCount').text(`${csvData.length} Total`);

                if (validCount > 0) {
                    $('#sendBulkInviteBtn').prop('disabled', false);
                } else {
                    $('#sendBulkInviteBtn').prop('disabled', true);
                }
            }

            // Handle ticket type change
            $(document).on('change', '.ticket-type-select', function() {
                const index = $(this).data('index');
                const newTicketType = $(this).val();
                
                // Update csvData
                const rowData = csvData.find(r => r.index === index);
                if (rowData) {
                    rowData.ticketType = newTicketType;
                }

                validateAndUpdateRow(index);
            });

            // Handle editable field changes
            $(document).on('blur', '.editable-field', function() {
                const index = $(this).data('index');
                const field = $(this).data('field');
                const value = $(this).val().trim();
                
                // Update csvData
                const rowData = csvData.find(r => r.index === index);
                if (rowData) {
                    rowData[field] = value;
                }

                validateAndUpdateRow(index);
            });

            // Validate and update row appearance
            function validateAndUpdateRow(index) {
                const rowData = csvData.find(r => r.index === index);
                if (!rowData) return;

                const validTicketTypes = ['visitor', 'vip', 'gold', 'platinum', 'exhibitor'];
                const hasValidTicketType = validTicketTypes.includes(rowData.ticketType);
                const hasValidEmail = rowData.email && validateEmail(rowData.email);
                const isValid = rowData.name && hasValidEmail && hasValidTicketType;

                const $row = $(`tr[data-index="${index}"]`);
                if (isValid) {
                    $row.removeClass('table-danger');
                    $row.find('td:eq(5)').html('<span class="badge bg-success">Valid</span>');
                } else {
                    $row.addClass('table-danger');
                    $row.find('td:eq(5)').html('<span class="badge bg-danger">Invalid</span>');
                }

                updateValidationCounts();
            }

            // Handle row deletion
            $(document).on('click', '.delete-row-btn', function() {
                const index = $(this).data('index');
                
                // Remove from csvData
                csvData = csvData.filter(r => r.index !== index);
                
                // Remove row from table
                $(`tr[data-index="${index}"]`).remove();
                
                // Update counts
                updateValidationCounts();

                // If no rows left, hide preview and disable button
                if (csvData.length === 0) {
                    $('#csvPreviewSection').hide();
                    $('#sendBulkInviteBtn').prop('disabled', true);
                }
            });

            // Clear all preview
            $('#clearPreviewBtn').on('click', function() {
                Swal.fire({
                    icon: 'warning',
                    title: 'Clear All Data?',
                    text: 'This will remove all uploaded data. Are you sure?',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, Clear All',
                    confirmButtonColor: '#d33'
                }).then((result) => {
                    if (result.isConfirmed) {
                        csvData = [];
                        $('#csvPreviewBody').empty();
                        $('#csvPreviewSection').hide();
                        $('#sendBulkInviteBtn').prop('disabled', true);
                        $('#bulkCsvFile').val('');
                    }
                });
            });

            // Add manual row button - FIXED
            $(document).on('click', '#addManualRowBtn', function() {
                // Show preview section if hidden
                if (!$('#csvPreviewSection').is(':visible')) {
                    $('#csvPreviewSection').show();
                }

                // Generate new index
                const newIndex = csvData.length > 0 ? Math.max(...csvData.map(r => r.index)) + 1 : 1;

                // Create new row data
                const newRow = {
                    index: newIndex,
                    name: '',
                    email: '',
                    ticketType: '',
                    company: '',
                    message: ''
                };

                csvData.push(newRow);

                const validTicketTypes = ['visitor', 'vip', 'gold', 'platinum', 'exhibitor'];
                addPreviewRow(newRow, validTicketTypes);

                updateValidationCounts();

                // Scroll to the new row and focus
                setTimeout(() => {
                    const $newRow = $(`tr[data-index="${newIndex}"]`);
                    if ($newRow.length) {
                        $newRow[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                        $newRow.find('.editable-field[data-field="name"]').focus();
                    }
                }, 100);

                Swal.fire({
                    icon: 'success',
                    title: 'Row Added',
                    text: 'Fill in the details for the new recipient',
                    timer: 1500,
                    showConfirmButton: false
                });
            });

            function validateEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }

            // Download CSV Template
            $('#downloadTemplateBtn').on('click', function() {
                const csvContent = 'Full Name,Email,Ticket Type,Company Name,Personal Message\nJohn Doe,john@example.com,visitor,ABC Corp,Looking forward to seeing you\nJane Smith,jane@example.com,vip,XYZ Inc,';
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bulk_invitation_template.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            });

            // Send Bulk - AJAX with FormData for file
        $('#sendBulkInviteBtn').click(function() {
            if ($('#bulkPersonalizedForm')[0].checkValidity() && csvData.length > 0) {
                const validRows = csvData.filter(row => 
                    row.name && row.email && validateEmail(row.email) && row.ticketType
                );
                
                if (validRows.length === 0) {
                    Swal.fire('Error', 'No valid rows to send', 'error');
                    return;
                }
                
                Swal.fire({
                    icon: 'question',
                    title: 'Send Bulk Invitations',
                    html: `Send to <strong>${validRows.length}</strong> valid recipients?`,
                    showCancelButton: true,
                    confirmButtonText: 'Send All'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const formData = new FormData();
                        // Since JS parses CSV, but to send file, get the file
                        const fileInput = $('#bulkCsvFile')[0];
                        if (fileInput.files[0]) {
                            formData.append('bulkCsvFile', fileInput.files[0]);
                        }
                        formData.append('bulkPersonalMessage', $('#bulkPersonalMessage').val());
                        formData.append('bulkExpireDate', $('#bulkExpireDate').val());
                        
                        // But since preview edits, perhaps send the csvData as JSON, but for simplicity, assume original file is ok, or regenerate CSV from csvData
                        // For now, send file as is (edits not persisted to file, but for demo)
                        
                        $.ajax({
                            url: '{% url "invitations:send_bulk_personalized_invitation" %}',  // Add URL
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            success: function(response) {
                                if (response.success) {
                                    $('#bulkPersonalizedModal').modal('hide');
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Bulk Sent!',
                                        html: `${response.valid_count} invitations sent. ${response.error_count} errors.<br>${response.errors.join('<br>') || 'No errors'}`,
                                        timer: 5000
                                    });
                                    $('#bulkPersonalizedForm')[0].reset();
                                    $('#csvPreviewSection').hide();
                                    csvData = [];
                                    // Refresh table
                                    location.reload();
                                } else {
                                    Swal.fire('Error', response.error, 'error');
                                }
                            },
                            error: function() {
                                Swal.fire('Error', 'Failed to send bulk invitations', 'error');
                            }
                        });
                    }
                });
            } else {
                $('#bulkPersonalizedForm')[0].reportValidity();
            }
            });

            // Initialize DataTable
            const table = $('#invitationTable').DataTable({
                pageLength: 10,
                responsive: true,
                order: [[1, 'desc']],
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
                language: {
                    lengthMenu: "Show _MENU_ entries",
                    search: "Search:",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                },
                columnDefs: [
                    { orderable: false, targets: [0, 9] },
                    { className: 'text-center', targets: [0] }
                ],
                ajax: {
                    url: '{% url "invitations:invitation_list" %}',  // Add URL for list view
                    dataSrc: 'data'
                },
                columns: [
                    {
                        data: null,
                        render: function(data, type, row, meta) {
                            return `<input type="checkbox" class="table-checkbox row-checkbox" data-id="${meta.row}">`;
                        }
                    },
                    { data: 'name' },
                    { data: 'email' },
                    { data: 'type' },
                    { data: 'expiry' },
                    { data: 'limit' },
                    { data: 'registered' },
                    { 
                        data: null,
                        render: function() {
                            return '<button class="btn btn-sm btn-primary copy-link"><i class="fas fa-copy me-1"></i>Copy Link</button>';
                        }
                    },
                    {
                        data: 'status',
                        render: function(data) {
                            const statusClass = data === 'Active' ? 'success' : data === 'Pending' ? 'warning' : 'secondary';
                            return `<span class="badge bg-${statusClass}">${data}</span>`;
                        }
                    },
                    {
                        data: null,
                        render: function() {
                            return `
                                <button class="btn btn-action btn-sm btn-info" title="View"><i class="fas fa-eye"></i></button>
                                <button class="btn btn-action btn-sm btn-warning" title="Edit"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-action btn-sm btn-danger" title="Delete"><i class="fas fa-trash"></i></button>
                            `;
                        }
                    }
                ],
                initComplete: function() {
                    $('.dataTables_length select').addClass('form-select form-select-sm').css({
                        'width': 'auto',
                        'display': 'inline-block',
                        'margin': '0 8px'
                    });
                    
                    $('.dataTables_filter input').addClass('form-control form-control-sm').css({
                        'width': 'auto',
                        'display': 'inline-block',
                        'margin-left': '8px'
                    });
                }
            });

            // Generate Sample Data
            function generateSampleData() {
                const names = ['Annaleen Pimentel', 'John Smith', 'Sarah Johnson', 'Michael Chen', 'Emma Wilson'];
                const data = [];
                for (let i = 0; i < 50; i++) {
                    data.push({
                        name: names[Math.floor(Math.random() * names.length)] + ' - 100 links',
                        email: 'View',
                        type: 'Invitation Link',
                        expiry: '17th Oct 2025',
                        limit: Math.floor(Math.random() * 10) + 1,
                        registered: Math.floor(Math.random() * 5),
                        status: ['Active', 'Pending', 'Expired'][Math.floor(Math.random() * 3)]
                    });
                }
                return data;
            }

            // Checkbox Selection Logic
            let selectedRows = new Set();

            $('#selectAll').on('change', function() {
                const isChecked = $(this).prop('checked');
                $('.row-checkbox').prop('checked', isChecked);
                
                if (isChecked) {
                    $('.row-checkbox').each(function() {
                        selectedRows.add($(this).data('id'));
                        $(this).closest('tr').addClass('selected');
                    });
                } else {
                    selectedRows.clear();
                    $('tbody tr').removeClass('selected');
                }
                updateBulkActionsBar();
            });

            $(document).on('change', '.row-checkbox', function() {
                const rowId = $(this).data('id');
                const isChecked = $(this).prop('checked');
                
                if (isChecked) {
                    selectedRows.add(rowId);
                    $(this).closest('tr').addClass('selected');
                } else {
                    selectedRows.delete(rowId);
                    $(this).closest('tr').removeClass('selected');
                }
                
                const totalCheckboxes = $('.row-checkbox').length;
                const checkedCheckboxes = $('.row-checkbox:checked').length;
                $('#selectAll').prop('checked', totalCheckboxes === checkedCheckboxes);
                $('#selectAll').prop('indeterminate', checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
                
                updateBulkActionsBar();
            });

            function updateBulkActionsBar() {
                const count = selectedRows.size;
                if (count > 0) {
                    $('#bulkActionsBar').addClass('show');
                    $('#selectedCount').text(count);
                } else {
                    $('#bulkActionsBar').removeClass('show');
                }
            }

            $('#clearSelectionBtn').click(function() {
                selectedRows.clear();
                $('.row-checkbox, #selectAll').prop('checked', false);
                $('tbody tr').removeClass('selected');
                updateBulkActionsBar();
            });

            $('#bulkSendBtn').click(function() {
                Swal.fire({
                    icon: 'info',
                    title: 'Send Invitations',
                    text: `Send invitations to ${selectedRows.size} selected items?`,
                    showCancelButton: true,
                    confirmButtonText: 'Send All'
                }).then((result) => {
                    if (result.isConfirmed) {
                        showLoading();
                        setTimeout(() => {
                            hideLoading();
                            Swal.fire('Sent!', `${selectedRows.size} invitations have been sent.`, 'success');
                            $('#clearSelectionBtn').click();
                        }, 1500);
                    }
                });
            });

            $('#bulkActivateBtn').click(function() {
                Swal.fire({
                    icon: 'question',
                    title: 'Activate Selected',
                    text: `Activate ${selectedRows.size} selected items?`,
                    showCancelButton: true,
                    confirmButtonText: 'Activate'
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire('Activated!', `${selectedRows.size} items have been activated.`, 'success');
                        $('#clearSelectionBtn').click();
                    }
                });
            });

            $('#bulkDeactivateBtn').click(function() {
                Swal.fire({
                    icon: 'warning',
                    title: 'Deactivate Selected',
                    text: `Deactivate ${selectedRows.size} selected items?`,
                    showCancelButton: true,
                    confirmButtonText: 'Deactivate'
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire('Deactivated!', `${selectedRows.size} items have been deactivated.`, 'success');
                        $('#clearSelectionBtn').click();
                    }
                });
            });

            $('#bulkExportBtn').click(function() {
                showLoading();
                setTimeout(() => {
                    hideLoading();
                    Swal.fire('Exported!', `${selectedRows.size} items have been exported to Excel.`, 'success');
                }, 1000);
            });

            $('#bulkDeleteBtn').click(function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Delete Selected',
                    text: `Are you sure you want to delete ${selectedRows.size} selected items?`,
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Delete All'
                }).then((result) => {
                    if (result.isConfirmed) {
                        showLoading();
                        setTimeout(() => {
                            hideLoading();
                            Swal.fire('Deleted!', `${selectedRows.size} items have been deleted.`, 'success');
                            selectedRows.forEach(rowId => {
                                table.row(rowId).remove();
                            });
                            table.draw();
                            $('#clearSelectionBtn').click();
                        }, 1000);
                    }
                });
            });

            $('#sidebarToggle').click(function() {
                $('#sidebar').toggleClass('show');
            });

            $('.nav-item').click(function(e) {
                e.preventDefault();
                $('.nav-item').removeClass('active');
                $(this).addClass('active');
            });

            function updateCountdown() {
                const countdown = $('#countdown');
                let days = 16, hours = 17, minutes = 45, seconds = 19;
                
                setInterval(function() {
                    seconds--;
                    if (seconds < 0) {
                        seconds = 59;
                        minutes--;
                        if (minutes < 0) {
                            minutes = 59;
                            hours--;
                            if (hours < 0) {
                                hours = 23;
                                days--;
                            }
                        }
                    }
                    
                    countdown.html(`
                        <span>${days}<small>Days</small></span>
                        <span>${hours}<small>Hours</small></span>
                        <span>${minutes}<small>Mins</small></span>
                        <span>${seconds}<small>Secs</small></span>
                    `);
                }, 1000);
            }
            updateCountdown();

            $('.stat-value').each(function() {
                const $this = $(this);
                
                const countTo = parseInt($this.attr('data-count'), 10) || 0;
                $({ countNum: 0 }).animate({
                    countNum: countTo
                }, {
                    duration: 1500,
                    easing: 'swing',
                    step: function() {
                        $this.text(Math.floor(this.countNum));
                    },
                    complete: function() {
                        $this.text(this.countNum);
                    }
                });
            });

            $(document).on('click', '.copy-link', function() {
                const rowData = table.row($(this).parents('tr')).data();
                const invitationKey = rowData.key;
                navigator.clipboard.writeText(`https://gitex.com/invite/${invitationKey}`);
                const btn = $(this);
                const originalHtml = btn.html();
                btn.html('<i class="fas fa-check me-1"></i>Copied!').addClass('btn-success').removeClass('btn-primary');
                setTimeout(() => {
                    btn.html(originalHtml).addClass('btn-primary').removeClass('btn-success');
                }, 2000);
            });

            $('#searchBtn').click(function() {
                showLoading();
                setTimeout(() => {
                    const keyword = $('#searchKeyword').val();
                    table.search(keyword).draw();
                    hideLoading();
                    Swal.fire({
                        icon: 'success',
                        title: 'Search Complete',
                        text: `Found ${table.page.info().recordsDisplay} results`,
                        timer: 1500,
                        showConfirmButton: false
                    });
                }, 500);
            });

            $('#resetBtn').click(function() {
                $('#searchKeyword').val('');
                $('#filterStatus').val('').trigger('change');
                $('#filterType').val('').trigger('change');
                $('#filterDate').val('');
                table.search('').draw();
            });

            $('#exportBtn').click(function() {
                Swal.fire({
                    title: 'Export Data',
                    text: 'Select export format',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Excel',
                    cancelButtonText: 'CSV',
                    showDenyButton: true,
                    denyButtonText: 'PDF'
                }).then((result) => {
                    if (result.isConfirmed || result.isDenied || result.dismiss === Swal.DismissReason.cancel) {
                        showLoading();
                        setTimeout(() => {
                            hideLoading();
                            Swal.fire('Exported!', 'Your file has been downloaded.', 'success');
                        }, 1000);
                    }
                });
            });

            $('#submitLinkBtn').click(function() {
                if ($('#generateLinkForm')[0].checkValidity()) {
                    showLoading();
                    setTimeout(() => {
                        hideLoading();
                        $('#generateLinkModal').modal('hide');
                        Swal.fire({
                            icon: 'success',
                            title: 'Link Generated!',
                            html: `
                                <p>Your invitation link has been created:</p>
                                <div class="input-group mt-3">
                                    <input type="text" class="form-control" value="https://gitex.com/invite/XYZ789" readonly>
                                    <button class="btn btn-primary" onclick="navigator.clipboard.writeText('https://gitex.com/invite/XYZ789')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            `,
                            confirmButtonText: 'Done'
                        });
                        $('#generateLinkForm')[0].reset();
                    }, 1000);
                } else {
                    $('#generateLinkForm')[0].reportValidity();
                }
            });

            // Send Single Personalized Invitation - AJAX
        $('#sendInviteBtn').click(function() {
            if ($('#personalizedForm')[0].checkValidity()) {
                const personalExpireDate = $('#personalExpireDate').val();
                const today = new Date();
                const selectedDate = new Date(personalExpireDate);

                if (selectedDate < new Date(today.toDateString())) {
                    console.log('Invalid date');
                    Swal.fire('Invalid Date', "You can't choose an expired date.", 'error');
                    return;
                }
                const formData = {
                    guestName: $('#guestName').val(),
                    guestEmail: $('#guestEmail').val(),
                    ticketType: $('#ticketType').val().toLowerCase(),
                    companyName: $('#companyName').val(),
                    personalMessage: $('#personalMessage').val(),
                    personalExpireDate: $('#personalExpireDate').val()
                };
                
                $.ajax({
                    url: '{% url "invitations:send_personalized_invitation" %}',  // Add this URL in urls.py
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    headers: {
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()  // If using CSRF
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#personalizedModal').modal('hide');
                            Swal.fire({
                                icon: 'success',
                                title: 'Invitation Sent!',
                                text: response.message,
                                footer: `<a href="${response.link}">View Link</a>`
                            });
                            $('#personalizedForm')[0].reset();
                            // Refresh table if needed
                            location.reload();  // Or ajax reload table
                        } else {
                            Swal.fire('Error', response.error, 'error');
                        }
                    },
                    error: function() {
                        Swal.fire('Error', 'Failed to send invitation', 'error');
                    }
                });
            } else {
                $('#personalizedForm')[0].reportValidity();
            }
            });

            $('#refreshTable').click(function() {
                $(this).find('i').addClass('fa-spin');
                setTimeout(() => {
                    table.ajax.reload();
                    $(this).find('i').removeClass('fa-spin');
                }, 1000);
            });

            $(document).on('click', '.btn-action', function() {
                const action = $(this).attr('title');
                const row = table.row($(this).parents('tr')).data();
                
                switch(action) {
                    case 'View':
                        Swal.fire('View Details', `Viewing details for: ${row.name}`, 'info');
                        break;
                    case 'Edit':
                        Swal.fire('Edit Record', `Editing: ${row.name}`, 'info');
                        break;
                    case 'Broadcast':
                        Swal.fire('Broadcast', 'Broadcasting invitation link...', 'info');
                        break;
                    case 'Delete':
                        Swal.fire({
                            title: 'Are you sure?',
                            text: "You won't be able to revert this!",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#3085d6',
                            confirmButtonText: 'Yes, delete it!'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                Swal.fire('Deleted!', 'The invitation has been deleted.', 'success');
                            }
                        });
                        break;
                }
            });

            function showLoading() {
                $('#loadingOverlay').addClass('show');
            }

            function hideLoading() {
                $('#loadingOverlay').removeClass('show');
            }

            $('[title]').tooltip();

            const today = new Date();
            const futureDate = new Date(today.setMonth(today.getMonth() + 1));
            $('#expireDate, #personalExpireDate').val(futureDate.toISOString().split('T')[0]);
        });


        


    </script>
{% endblock %}
