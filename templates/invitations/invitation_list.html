{% extends 'base/base.html' %}
{% load static %}

{% block title %}Visitor Invitation{% endblock %}

{% block content %}
  <!-- Main Content -->
            <!-- Page Header -->
            <div class="page-header animate-fade-in">
                <h1 class="page-title">Visitor Invitation</h1>
                <p class="page-description">
                    Send complimentary Visitor Pass invitations for GITEX GLOBAL 2025 and Expand North Star 2025.
                </p>
            </div>

        <!-- Ticket Type Stats Cards -->
<!-- Ticket Type Stats Cards -->
  <div class="row mb-4 animate-fade-in">
    {% for ticket_type in ticket_types %}
    <div class="col-md-4 mb-2">
      <div class="stat-card">
        <div class="stat-icon {{ ticket_type.color_class }}">
          <i class="fas fa-ticket-alt"></i>
        </div>
        <div class="stat-content">
          <div class="stat-value" data-count="{{ ticket_type.available }}">{{ ticket_type.available }} Available</div>
          <div class="stat-label">{{ ticket_type.name|title }} ({{ ticket_type.used }}/{{ ticket_type.total }})</div>
        </div>
      </div>
    </div>
    {% empty %}
    <div class="col-12">
      <p class="text-muted">No ticket types available.</p>
    </div>
    {% endfor %}
  </div>

            <!-- Action Cards -->
            <div class="row mb-3 animate-fade-in">
                <div class="col-md-4 mb-2">
                    <div class="action-card" data-bs-toggle="modal" data-bs-target="#personalizedModal">
                        <div class="d-flex align-items-center">
                            <div class="action-card-icon me-3">
                                <i class="fas fa-envelope-open-text"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5>Send Personalized Invitation</h5>
                                <p class="text-muted mb-2">Send a personalized invitation to a guest</p>
                                <button class="btn btn-sm btn-primary">
                                    <i class="fas fa-paper-plane me-1"></i>Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="action-card" data-bs-toggle="modal" data-bs-target="#bulkPersonalizedModal">
                        <div class="d-flex align-items-center">
                            <div class="action-card-icon me-3">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5>Send Bulk Personalized Invitation</h5>
                                <p class="text-muted mb-2">Upload CSV and send to multiple guests</p>
                                <button class="btn btn-sm btn-success">
                                    <i class="fas fa-file-upload me-1"></i>Upload
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-2">
                    <div class="action-card" data-bs-toggle="modal" data-bs-target="#generateLinkModal">
                        <div class="d-flex align-items-center">
                            <div class="action-card-icon me-3">
                                <i class="fas fa-link"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h5>Generate Invitation Link</h5>
                                <p class="text-muted mb-2">Generate and share generic link</p>
                                <button class="btn btn-sm btn-primary">
                                    <i class="fas fa-share-alt me-1"></i>Generate
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-3 animate-fade-in">
                <div class="col-lg-3 col-md-6 mb-2">
                    <div class="stat-card">
                        <div class="stat-icon primary">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" data-count="{{ allocated_invitations }}"></div>
                            <div class="stat-label">Allocated Invitations</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-2">
                    <div class="stat-card">
                        <div class="stat-icon success">
                            <i class="fas fa-share"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" data-count="{{ generated_invitations }}">0</div>
                            <div class="stat-label">Generated Invitations</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-2">
                    <div class="stat-card">
                        <div class="stat-icon info">
                            <i class="fas fa-hourglass-half"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" data-count="{{ remaining_invitations }}">0</div>
                            <div class="stat-label">Remaining Invitations</div>
                        </div>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6 mb-2">
                    <div class="stat-card">
                        <div class="stat-icon warning">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-content">
                            <div class="stat-value" data-count="{{ registered_visitors }}">{{ registered_visitors }}</div>
                            <div class="stat-label">Registered Visitors</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filter Section -->
            <div class="filter-section animate-fade-in">
                <div class="row g-2">
                    <div class="col-md-3">
                        <label class="form-label small text-muted">Keyword</label>
                        <input type="text" class="form-control form-control-sm" placeholder="Search..." id="searchKeyword">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">Status</label>
                        <select class="form-select form-select-sm select2" id="filterStatus" style="border: 1px solid #dee2e6;">
                            <option value="">All</option>
                            <option value="active">Active</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small text-muted">Type</label>
                        <select class="form-select form-select-sm select2" id="filterType" style="border: 1px solid #dee2e6;">
                            <option value="">All</option>  
                            <option value="link">Private Link</option>
                            <option value="personalized">Personalized Link</option>
                        </select>
                    </div>
                    <div class="col-md-1">
                        <label class="form-label small text-muted">Expiry</label>
                        <input type="date" class="form-control form-control-sm" id="filterDate">
                    </div>
                    <div class="col-md-3 d-flex align-items-end gap-1">
                        <button class="btn btn-sm btn-primary" id="searchBtn">
                            <i class="fas fa-search"></i> Search
                        </button>
                        <button class="btn btn-sm btn-secondary" id="resetBtn">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button class="btn btn-sm btn-success ms-auto" id="exportBtn">
                            <i class="fas fa-download"></i> Export
                        </button>
                      
                    </div>
                    <div class="col-md-1">
                        <a class="btn btn-sm btn-primary ms-auto" href="{% url 'invitations:exports_jobes' %}">
                            <i class="fas fa-history"></i> Export Jobs
                        </a>
                    </div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="table-wrapper animate-fade-in">
                <div class="table-actions">
                    <h5 class="mb-0">Invitation List</h5>
                    <div class="action-btn-group">
                        <button class="btn btn-sm btn-outline-primary" id="refreshTable">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="columnToggle">
                            <i class="fas fa-columns"></i>
                        </button>
                    </div>
                </div>
                
                <!-- Bulk Actions Bar -->
                <div class="bulk-actions-bar" id="bulkActionsBar">
                    <div class="bulk-actions-info">
                        <i class="fas fa-check-circle text-primary me-2"></i>
                        <span id="selectedCount">0</span> items selected
                    </div>
                    <div class="bulk-actions-buttons">
                        <button class="btn btn-sm btn-primary" id="bulkSendBtn">
                            <i class="fas fa-paper-plane me-1"></i>Send Invites
                        </button>
                        <button class="btn btn-sm btn-success" id="bulkActivateBtn">
                            <i class="fas fa-check me-1"></i>Activate
                        </button>
                        <button class="btn btn-sm btn-warning" id="bulkDeactivateBtn">
                            <i class="fas fa-pause me-1"></i>Deactivate
                        </button>
                        <button class="btn btn-sm btn-info" id="bulkExportBtn">
                            <i class="fas fa-download me-1"></i>Export Selected
                        </button>
                        <button class="btn btn-sm btn-danger" id="bulkDeleteBtn">
                            <i class="fas fa-trash me-1"></i>Delete
                        </button>
                        <button class="btn btn-sm btn-secondary" id="clearSelectionBtn">
                            <i class="fas fa-times me-1"></i>Clear
                        </button>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="table table-hover" id="invitationTable">
                        <thead>
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" class="table-checkbox" id="selectAll">
                                </th>
                                <th>Link Title / Full Name</th>
                                <th>Email Address</th>
                                <th>Invite Type</th>
                                <th>Expiry Date</th>
                                <th>Link Limit</th>
                                <th>Registered</th>
                                <th>Invitation Link</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table rows will be populated by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>

{% endblock %}


{% block modal_block %}
<!-- Generate Link Modal -->
    <div class="modal fade" id="generateLinkModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-link text-primary me-2"></i>Create Private Invite Link
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="generateLinkForm">
                        <div class="mb-3">
                            <label class="form-label">Invitation Link Title <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="linkTitle" required>
                            <small class="text-muted">Give your invitation link a descriptive title</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Ticket Type <span class="text-danger">*</span></label>
                                <select class="form-select select2-modal" id="linkTicketType" required>
                                    <option value="">Select Ticket Type</option>
                                    <option value="visitor">Visitor</option>
                                    <option value="vip">VIP</option>
                                    <option value="gold">Gold</option>
                                    <option value="platinum">Platinum</option>
                                    <option value="exhibitor">Exhibitor</option>
                            </select>
                        </div>

                        
                        <div class="mb-3">
                            <label class="form-label">Expire Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="expireDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">How many invitation links do you need? <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="linkCount" min="1" max="1000" required>
                            <small class="text-muted">Maximum 1000 links per batch</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">How many times each link can be used? <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="linkLimit" min="1" max="100" required>
                            <small class="text-muted">Maximum 100 uses per link</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitLinkBtn">
                        <i class="fas fa-check me-2"></i>Generate Link
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Personalized Invitation Modal -->
    <div class="modal fade" id="personalizedModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-envelope text-primary me-2"></i>Send Personalized Invitation
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="personalizedForm">
                    <div class="mb-3">
                        <label class="form-label">Guest Full Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="guestName" required pattern="[A-Za-z\s\-\']{2,255}" title="Name can only contain letters, spaces, hyphens, or apostrophes (2-255 characters)">
                    </div>
                        <div class="mb-3">
                            <label class="form-label">Guest Email Address <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="guestEmail" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ticket Type <span class="text-danger">*</span></label>
                            <select class="form-select select2-modal" id="ticketType" required>
                                <option value="">Select Ticket Type</option>
                                <option value="visitor">Visitor</option>
                                <option value="vip">VIP</option>
                                <option value="gold">Gold</option>
                                <option value="platinum">Platinum</option>
                                <option value="exhibitor">Exhibitor</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-control" id="companyName">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Personal Message</label>
                            <textarea class="form-control" id="personalMessage" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Expire Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="personalExpireDate" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="sendInviteBtn">
                        <i class="fas fa-paper-plane me-2"></i>Send Invitation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Personalized Invitation Modal -->
    <div class="modal fade" id="bulkPersonalizedModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-users text-success me-2"></i>Send Bulk Personalized Invitations
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bulkPersonalizedForm">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Instructions:</strong> Upload a CSV file with columns: Full Name, Email, Ticket Type, Company Name (optional), Personal Message (optional)
                            <br><small class="mt-1 d-block">Ticket Type options: visitor, vip, gold, platinum, exhibitor</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Upload CSV File <span class="text-danger">*</span></label>
                            <input type="file" class="form-control" id="bulkCsvFile" accept=".csv" required>
                            <small class="text-muted">Maximum file size: 5MB</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Default Personal Message</label>
                            <textarea class="form-control" id="bulkPersonalMessage" rows="3" placeholder="This message will be added to all invitations..."></textarea>
                            <small class="text-muted">Optional: Add a message that applies to all recipients</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Expire Date <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="bulkExpireDate" required>
                        </div>

                        <div class="mb-3">
                            <button type="button" class="btn btn-sm btn-outline-primary" id="downloadTemplateBtn">
                                <i class="fas fa-download me-1"></i>Download CSV Template
                            </button>
                        </div>
                        <!-- commented -->
                        <!-- Preview Section -->
                        <div id="csvPreviewSection" style="display: none;">
                            <hr> 
                            <h6 class="mb-3">
                                <i class="fas fa-eye me-2"></i>CSV Preview
                                <span class="badge bg-warning text-dark ms-2" id="modifiedIndicator" style="display: none;">Modified</span>
                                <div class="float-end">
                                    <!-- <button type="button" class="btn btn-sm btn-info me-2" id="downloadCsvBtn" title="Download modified CSV">
                                        <i class="fas fa-download me-1"></i>Download CSV
                                    </button> -->
                                    <button type="button" class="btn btn-sm btn-warning me-2" id="clearDuplicatesBtn" title="Remove all duplicate rows">
                                        <i class="fas fa-copy me-1"></i>Clear Duplicates
                                    </button>
                                    <button type="button" class="btn btn-sm btn-warning me-2" id="clearInvalidBtn" title="Remove all invalid rows">
                                        <i class="fas fa-exclamation-triangle me-1"></i>Clear Invalid
                                    </button>
                                    <button type="button" class="btn btn-sm btn-success me-2" id="addManualRowBtn">
                                        <i class="fas fa-plus me-1"></i>Add Row
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" id="clearPreviewBtn">
                                        <i class="fas fa-trash me-1"></i>Clear All
                                    </button>
                                </div>
                            </h6>
                            <div class="table-responsive" id="csvTableContainer" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-sm table-bordered mb-0" id="csvPreviewTable">
                                    <thead class="table-light sticky-top">
                                        <tr>
                                            <th>#</th>
                                            <th>Full Name</th>
                                            <th>Email</th>
                                            <th>Ticket Type</th>
                                            <th>Company</th>
                                            <th>Status</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="csvPreviewBody">
                                    </tbody>
                                </table>
                            </div>
                            <!-- Pagination Controls -->
                            <div id="paginationControls"></div>
                            <div class="mt-2">
                                <span class="badge bg-success" id="validRowsCount">0 Valid</span>
                                <span class="badge bg-danger" id="invalidRowsCount">0 Invalid</span>
                                <span class="badge bg-info" id="duplicateRowsCount">0 Duplicate</span>
                                <span class="badge bg-info" id="distinctDuplicateEmails">0 Distinct Duplicate Emails</span>
                                <span class="badge bg-info" id="totalRowsCount">0 Total</span>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="sendBulkInviteBtn" disabled>
                        <i class="fas fa-paper-plane me-2"></i>Send Bulk Invitations
                    </button>
                </div>
            </div>
        </div>
    </div>



<!-- Edit Invitation Modal -->
<div class="modal fade" id="editInvitationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit text-warning me-2"></i>Edit Invitation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editInvitationForm">
                    <input type="hidden" id="editInvitationId">
                    <div class="mb-3">
                        <label class="form-label">Guest Full Name / Link Title <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editGuestName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Guest Email Address</label>
                        <input type="email" class="form-control" id="editGuestEmail" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ticket Type <span class="text-danger">*</span></label>
                        <select class="form-select select2-modal" id="editTicketType" required>
                            <option value="">Select Ticket Type</option>
                            <option value="visitor">Visitor</option>
                            <option value="vip">VIP</option>
                            <option value="gold">Gold</option>
                            <option value="platinum">Platinum</option>
                            <option value="exhibitor">Exhibitor</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Company Name</label>
                        <input type="text" class="form-control" id="editCompanyName">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Personal Message</label>
                        <textarea class="form-control" id="editPersonalMessage" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Expire Date <span class="text-danger">*</span></label>
                        <input type="date" class="form-control" id="editExpireDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Link Limit <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="editLinkLimit" min="1" max="100" required>
                        <small class="text-muted">Maximum 100 uses per link</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Status <span class="text-danger">*</span></label>
                        <select class="form-select select2-modal" id="editStatus" required>
                            <option value="active">Active</option>
                            <option value="deactivated">Deactivated</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="saveEditBtn">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block extra_scripts %} 
{{ invitation_base_url|json_script:"invitationBaseUrl" }}
 <script>
    let csvData = [];
        document.addEventListener('DOMContentLoaded', function() {
            var today = new Date().toISOString().split('T')[0];
            document.getElementById('personalExpireDate').setAttribute('min', today);

            console.log('Today\'s date set to:', today);
        });
        $(document).ready(function() {
            // Initialize Select2
            $('.select2').select2({
                theme: 'bootstrap-5',
                width: '100%'
            });

            // Initialize Select2 for modal (delayed to ensure modal is rendered)
            $('#personalizedModal, #generateLinkModal, #bulkPersonalizedModal').on('shown.bs.modal', function () {
                $('.select2-modal').select2({
                    theme: 'bootstrap-5',
                    width: '100%',
                    dropdownParent: $(this)
                });
            });

            // Clear bulk modal on close
            $('#bulkPersonalizedModal').on('hidden.bs.modal', function () {
                $('#bulkPersonalizedForm')[0].reset();
                $('#csvPreviewSection').hide();
                $('#csvPreviewBody').empty();
                csvData = [];
                $('#sendBulkInviteBtn').prop('disabled', true);
                $('#bulkCsvFile').val('');
            });

            // Add this inside your $(document).ready(function() { ... });

            // CSV File Upload Handler with Pagination
            let csvData = [];
            let currentPage = 1;
            const rowsPerPage = 50; // Show 50 rows at a time

            // Validate email helper function
            function validateEmail(email) {
                return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
            }

            // DEPRECATED: This function is replaced by createPreviewRowHTML for better performance
            // Kept for backward compatibility if needed elsewhere
            function addPreviewRow(row, validTicketTypes) {
                $('#csvPreviewBody').append(createPreviewRowHTML(row, validTicketTypes));
            }

            // OPTIMIZED: Update validation counts with efficient counting
            function updateValidationCounts() {
                const startTime = performance.now();
                const validTicketTypes = ['visitor', 'vip', 'gold', 'platinum', 'exhibitor'];

                let validCount = 0;
                let invalidCount = 0;
                let duplicateRowsCount = 0;
                let distinctDuplicateEmails = 0;

                // OPTIMIZATION 1: Rebuild email cache once for all validations
                rebuildEmailCache();

                // OPTIMIZATION 2: Count using the cache instead of repeated lookups
                csvData.forEach(row => {
                    const hasValidTicketType = validTicketTypes.includes(row.ticketType);
                    const hasValidEmail = row.email && validateEmail(row.email);
                    const isDuplicate = checkDuplicateEmail(row.index, row.email);
                    const isValid = row.name && hasValidEmail && hasValidTicketType && !isDuplicate;

                    if (isValid) {
                        validCount++;
                    } else {
                        invalidCount++;
                        if (isDuplicate) duplicateRowsCount++;
                    }
                });

                // OPTIMIZATION 3: Count distinct duplicates directly from cache
                for (const [email, indices] of emailIndexCache.entries()) {
                    if (indices.size > 1) {
                        distinctDuplicateEmails++;
                    }
                }

                // UI update
                $('#csvPreviewSection').show();
                $('#validRowsCount').text(`${validCount.toLocaleString()} Valid`);
                $('#invalidRowsCount').text(`${invalidCount.toLocaleString()} Invalid`);
                $('#totalRowsCount').text(`${csvData.length.toLocaleString()} Total`);
                $('#duplicateRowsCount').text(`${duplicateRowsCount.toLocaleString()} Duplicate Rows`);
                $('#distinctDuplicateEmails').text(`${distinctDuplicateEmails.toLocaleString()} Distinct Duplicate Emails`);

                // Enable/disable bulk-invite button
                $('#sendBulkInviteBtn').prop('disabled', validCount === 0);

                const elapsed = performance.now() - startTime;
                console.log(`Validation completed in ${elapsed.toFixed(2)}ms`);
            }

            // Update pagination controls
            function updatePaginationControls() {
                const totalPages = Math.ceil(csvData.length / rowsPerPage) || 1;
                
                let paginationHtml = `
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            Showing ${csvData.length > 0 ? ((currentPage - 1) * rowsPerPage) + 1 : 0} to ${Math.min(currentPage * rowsPerPage, csvData.length)} of ${csvData.length} rows
                        </div>
                        <div class="btn-group" role="group">
                            <button class="btn btn-sm btn-outline-primary" id="firstPageBtn" ${currentPage === 1 ? 'disabled' : ''}>
                                <i class="fas fa-angle-double-left"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" id="prevPageBtn" ${currentPage === 1 ? 'disabled' : ''}>
                                <i class="fas fa-angle-left"></i> Prev
                            </button>
                            <button class="btn btn-sm btn-primary" disabled>
                                Page ${currentPage} of ${totalPages}
                            </button>
                            <button class="btn btn-sm btn-outline-primary" id="nextPageBtn" ${currentPage === totalPages ? 'disabled' : ''}>
                                Next <i class="fas fa-angle-right"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" id="lastPageBtn" ${currentPage === totalPages ? 'disabled' : ''}>
                                <i class="fas fa-angle-double-right"></i>
                            </button>
                        </div>
                    </div>
                `;
                
                $('#paginationControls').html(paginationHtml);
            }

            // OPTIMIZED: Render paginated preview with direct innerHTML update
            function renderPreviewPage() {
                const validTicketTypes = ['visitor', 'vip', 'gold', 'platinum', 'exhibitor'];
                const startIndex = (currentPage - 1) * rowsPerPage;
                const endIndex = Math.min(startIndex + rowsPerPage, csvData.length);

                // OPTIMIZATION 1: Build all HTML in one string
                let htmlBatch = '';

                for (let i = startIndex; i < endIndex; i++) {
                    htmlBatch += createPreviewRowHTML(csvData[i], validTicketTypes);
                }

                // OPTIMIZATION 2: Single DOM update - directly set innerHTML on tbody
                // This is faster and works correctly with table elements (tbody properly parses <tr> tags)
                const tbody = document.getElementById('csvPreviewBody');
                tbody.innerHTML = htmlBatch;

                // OPTIMIZATION 3: Adjust container height dynamically to prevent white space
                adjustTableHeight();

                updatePaginationControls();
            }

            // Adjust table container height based on content
            function adjustTableHeight() {
                const container = document.getElementById('csvTableContainer');
                const table = document.getElementById('csvPreviewTable');

                if (!container || !table) return;

                const rowsOnPage = document.querySelectorAll('#csvPreviewBody tr').length;

                // If fewer rows, remove fixed height to prevent white space
                if (rowsOnPage <= 10) {
                    container.style.maxHeight = 'none';
                    container.style.overflowY = 'visible';
                } else {
                    // Reset to scrollable for many rows
                    container.style.maxHeight = '400px';
                    container.style.overflowY = 'auto';
                }
            }

            // OPTIMIZED: Create row HTML without jQuery for better performance
            function createPreviewRowHTML(row, validTicketTypes) {
                const hasValidTicketType = validTicketTypes.includes(row.ticketType);
                const hasValidEmail = row.email && validateEmail(row.email);
                const isDuplicate = checkDuplicateEmail(row.index, row.email);
                const isValid = row.name && hasValidEmail && hasValidTicketType && !isDuplicate;

                const statusBadge = isValid
                    ? '<span class="badge bg-success">Valid</span>'
                    : `<span class="badge bg-danger">${isDuplicate ? 'Duplicate Email' : 'Invalid'}</span>`;

                const rowClass = isValid ? '' : 'table-danger';

                // Escape HTML to prevent XSS
                const escapeHtml = (str) => String(str).replace(/[&<>"']/g, (match) => {
                    const escapeMap = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'};
                    return escapeMap[match];
                });

                const nameVal = escapeHtml(row.name);
                const emailVal = escapeHtml(row.email);
                const companyVal = escapeHtml(row.company);

                return `
                    <tr data-index="${row.index}" class="${rowClass}">
                        <td>${row.index}</td>
                        <td><input type="text" class="form-control form-control-sm editable-field" data-index="${row.index}" data-field="name" value="${nameVal}" style="font-size: 11px; border: 1px solid #ced4da; padding: 4px 8px;"></td>
                        <td><input type="email" class="form-control form-control-sm editable-field" data-index="${row.index}" data-field="email" value="${emailVal}" style="font-size: 11px; border: 1px solid #ced4da; padding: 4px 8px;"></td>
                        <td>
                            <select class="form-select form-select-sm ticket-type-select" data-index="${row.index}" style="font-size: 11px; border: 1px solid #ced4da; padding: 4px 8px; background-color: white;">
                                <option value="">Select Type</option>
                                <option value="visitor" ${row.ticketType === 'visitor' ? 'selected' : ''}>Visitor</option>
                                <option value="vip" ${row.ticketType === 'vip' ? 'selected' : ''}>VIP</option>
                                <option value="gold" ${row.ticketType === 'gold' ? 'selected' : ''}>Gold</option>
                                <option value="platinum" ${row.ticketType === 'platinum' ? 'selected' : ''}>Platinum</option>
                                <option value="exhibitor" ${row.ticketType === 'exhibitor' ? 'selected' : ''}>Exhibitor</option>
                            </select>
                        </td>
                        <td><input type="text" class="form-control form-control-sm editable-field" data-index="${row.index}" data-field="company" value="${companyVal}" style="font-size: 11px; border: 1px solid #ced4da; padding: 4px 8px;"></td>
                        <td>${statusBadge}</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-danger delete-row-btn" data-index="${row.index}" style="font-size: 10px; padding: 2px 6px;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }

            // OPTIMIZED: Parse CSV with faster regex-based parsing and larger chunks
            function parseCSV(text) {
                csvData = [];
                currentPage = 1;
                csvModified = false; // Reset modified flag for new upload
                $('#modifiedIndicator').hide();

                // Show progress indicator
                const startTime = performance.now();

                // OPTIMIZATION 1: Use faster line splitting with pre-allocation
                const lines = text.split(/\r?\n/);
                const totalLines = lines.length;

                // Skip header row
                let rowIndex = 1;
                const chunkSize = 5000; // Increased from 1000 for better performance

                // OPTIMIZATION 2: Pre-compile regex for CSV parsing (handles quoted values)
                const csvRegex = /(?:,|^)(?:"([^"]*)"|([^",]*))/g;

                function processChunk() {
                    const endIndex = Math.min(rowIndex + chunkSize, totalLines);
                    const batchStart = performance.now();

                    // OPTIMIZATION 3: Batch array operations
                    const batch = [];

                    for (let i = rowIndex; i < endIndex; i++) {
                        const line = lines[i];
                        if (!line || !line.trim()) continue;

                        // OPTIMIZATION 4: Fast CSV parsing with regex
                        const values = [];
                        let match;
                        csvRegex.lastIndex = 0; // Reset regex

                        while ((match = csvRegex.exec(line)) !== null) {
                            values.push((match[1] || match[2] || '').trim());
                        }

                        // Only process if we have at least name and email
                        if (values.length >= 2) {
                            batch.push({
                                index: i,
                                name: values[0] || '',
                                email: values[1] || '',
                                ticketType: values[2] ? values[2].toLowerCase() : '',
                                company: values[3] || '',
                                message: values[4] || ''
                            });
                        }
                    }

                    // OPTIMIZATION 5: Single array concatenation instead of multiple pushes
                    csvData = csvData.concat(batch);
                    rowIndex = endIndex;

                    const progress = Math.round((rowIndex / totalLines) * 100);
                    const elapsed = ((performance.now() - startTime) / 1000).toFixed(1);

                    Swal.update({
                        html: `
                            <div style="text-align: left;">
                                <strong>Processing CSV...</strong><br>
                                Progress: ${progress}%<br>
                                Rows loaded: ${csvData.length.toLocaleString()}<br>
                                Time elapsed: ${elapsed}s
                            </div>
                        `
                    });

                    if (rowIndex < totalLines) {
                        // OPTIMIZATION 6: Use requestAnimationFrame for smoother UI
                        requestAnimationFrame(() => setTimeout(processChunk, 0));
                    } else {
                        // Done processing
                        const totalTime = ((performance.now() - startTime) / 1000).toFixed(2);
                        console.log(`CSV parsing completed: ${csvData.length} rows in ${totalTime}s`);

                        Swal.close();

                        // OPTIMIZATION 7: Defer validation to prevent blocking
                        setTimeout(() => {
                            renderPreviewPage();
                            updateValidationCounts();

                            Swal.fire({
                                icon: 'success',
                                title: 'CSV Loaded',
                                html: `Successfully loaded <strong>${csvData.length.toLocaleString()}</strong> rows in ${totalTime}s`,
                                timer: 2500,
                                showConfirmButton: false
                            });
                        }, 100);
                    }
                }

                processChunk();
            }

            // OPTIMIZED: Email lookup cache for fast duplicate detection
            let emailIndexCache = new Map(); // email -> Set of indices

            // Rebuild email cache after data changes
            function rebuildEmailCache() {
                emailIndexCache.clear();
                csvData.forEach((row) => {
                    if (row.email) {
                        const emailLower = row.email.toLowerCase();
                        if (!emailIndexCache.has(emailLower)) {
                            emailIndexCache.set(emailLower, new Set());
                        }
                        emailIndexCache.get(emailLower).add(row.index);
                    }
                });
            }

            // OPTIMIZED: O(1) duplicate check using cache instead of O(n) array scan
            function checkDuplicateEmail(currentIndex, email) {
                if (!email) return false;
                const emailLower = email.toLowerCase();
                const indices = emailIndexCache.get(emailLower);
                if (!indices) return false;
                // Duplicate if there are other rows with same email
                return indices.size > 1 || (indices.size === 1 && !indices.has(currentIndex));
            }

            // OPTIMIZED: Debounce helper for validation
            let validationDebounceTimer = null;

            function debounceValidation(callback, delay = 300) {
                clearTimeout(validationDebounceTimer);
                validationDebounceTimer = setTimeout(callback, delay);
            }

            // OPTIMIZED: Validate and update row appearance with caching
            function validateAndUpdateRow(index, skipFullValidation = false) {
                const rowData = csvData.find(r => r.index === index);
                if (!rowData) return;

                const validTicketTypes = ['visitor', 'vip', 'gold', 'platinum', 'exhibitor'];

                // Update email cache if email changed
                rebuildEmailCache();

                const hasValidTicketType = validTicketTypes.includes(rowData.ticketType);
                const hasValidEmail = rowData.email && validateEmail(rowData.email);
                const isDuplicate = checkDuplicateEmail(rowData.index, rowData.email);
                const isValid = rowData.name && hasValidEmail && hasValidTicketType;

                const $row = $(`tr[data-index="${index}"]`);
                if ($row.length) {
                    if (isValid) {
                        $row.removeClass('table-danger');
                        if (isDuplicate) {
                            $row.find('td:eq(5)').html('<span class="badge bg-danger">Duplicate Email</span>');
                        } else {
                            $row.find('td:eq(5)').html('<span class="badge bg-success">Valid</span>');
                        }
                    } else {
                        $row.addClass('table-danger');
                        if (isDuplicate) {
                            $row.find('td:eq(5)').html('<span class="badge bg-danger">Duplicate Email</span>');
                        } else {
                            $row.find('td:eq(5)').html('<span class="badge bg-danger">Invalid</span>');
                        }
                    }
                }

                // OPTIMIZATION: Debounce full validation count update
                if (!skipFullValidation) {
                    debounceValidation(() => updateValidationCounts());
                }
            }

            // FILE UPLOAD EVENT
            $('#bulkCsvFile').on('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.size > 5 * 1024 * 1024) {
                        Swal.fire('Error', 'File size exceeds 5MB limit', 'error');
                        $(this).val('');
                        return;
                    }

                    // Show loading indicator
                    Swal.fire({
                        title: 'Processing CSV...',
                        html: 'Please wait while we parse your file',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const text = e.target.result;
                        parseCSV(text);
                    };
                    reader.readAsText(file);
                }
            });

            // Handle ticket type change
            $(document).on('change', '.ticket-type-select', function() {
                const index = $(this).data('index');
                const newTicketType = $(this).val();

                // Update csvData
                const rowData = csvData.find(r => r.index === index);
                if (rowData) {
                    rowData.ticketType = newTicketType;
                    markAsModified(); // Mark as modified
                }

                validateAndUpdateRow(index);
            });

            // Handle editable field changes
            $(document).on('blur', '.editable-field', function() {
                const index = $(this).data('index');
                const field = $(this).data('field');
                const value = $(this).val().trim();

                // Update csvData
                const rowData = csvData.find(r => r.index === index);
                if (rowData) {
                    rowData[field] = value;
                    markAsModified(); // Mark as modified
                }

                validateAndUpdateRow(index);
            });

            // OPTIMIZED: Handle row deletion with cache update
            $(document).on('click', '.delete-row-btn', function() {
                const index = $(this).data('index');

                // Remove from csvData
                csvData = csvData.filter(r => r.index !== index);
                markAsModified(); // Mark as modified

                // OPTIMIZATION: Rebuild cache after deletion (called in updateValidationCounts)

                // Re-render current page
                const totalPages = Math.ceil(csvData.length / rowsPerPage);
                if (currentPage > totalPages && totalPages > 0) {
                    currentPage = totalPages;
                }

                renderPreviewPage();
                updateValidationCounts();

                // If no rows left, hide preview and disable button
                if (csvData.length === 0) {
                    $('#csvPreviewSection').hide();
                    $('#sendBulkInviteBtn').prop('disabled', true);
                    emailIndexCache.clear(); // Clear cache
                    csvModified = false; // Reset modified flag
                    $('#modifiedIndicator').hide();
                }
            });

            // Pagination button handlers
            $(document).on('click', '#firstPageBtn', function() {
                currentPage = 1;
                renderPreviewPage();
            });

            $(document).on('click', '#prevPageBtn', function() {
                if (currentPage > 1) {
                    currentPage--;
                    renderPreviewPage();
                }
            });

            $(document).on('click', '#nextPageBtn', function() {
                const totalPages = Math.ceil(csvData.length / rowsPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderPreviewPage();
                }
            });

            $(document).on('click', '#lastPageBtn', function() {
                currentPage = Math.ceil(csvData.length / rowsPerPage);
                renderPreviewPage();
            });

            // OPTIMIZED: Clear all preview with cache cleanup
            $('#clearPreviewBtn').on('click', function() {
                Swal.fire({
                    icon: 'warning',
                    title: 'Clear All Data?',
                    text: 'This will remove all uploaded data. Are you sure?',
                    showCancelButton: true,
                    confirmButtonText: 'Yes, Clear All',
                    confirmButtonColor: '#d33'
                }).then((result) => {
                    if (result.isConfirmed) {
                        csvData = [];
                        currentPage = 1;
                        emailIndexCache.clear(); // Clear cache
                        csvModified = false; // Reset modified flag
                        $('#modifiedIndicator').hide();
                        $('#csvPreviewBody').empty();
                        $('#csvPreviewSection').hide();
                        $('#sendBulkInviteBtn').prop('disabled', true);
                        $('#bulkCsvFile').val('');
                    }
                });
            });

            // Add manual row button
            $(document).on('click', '#addManualRowBtn', function() {
                // Show preview section if hidden
                if (!$('#csvPreviewSection').is(':visible')) {
                    $('#csvPreviewSection').show();
                }

                // Generate new index
                const newIndex = csvData.length > 0 ? Math.max(...csvData.map(r => r.index)) + 1 : 1;

                // Create new row data
                const newRow = {
                    index: newIndex,
                    name: '',
                    email: '',
                    ticketType: '',
                    company: '',
                    message: ''
                };

                csvData.push(newRow);
                markAsModified(); // Mark as modified

                // Go to last page where new row will be
                currentPage = Math.ceil(csvData.length / rowsPerPage);
                renderPreviewPage();
                updateValidationCounts();

                // // Scroll to the new row and focus
                // setTimeout(() => {
                //     const $newRow = $(`tr[data-index="${newIndex}"]`);
                //     if ($newRow.length) {
                //         $newRow[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
                //         $newRow.find('.editable-field[data-field="name"]').focus();
                //     }
                // }, 100);

                // Swal.fire({
                //     icon: 'success',
                //     title: 'Row Added',
                //     text: 'Fill in the details for the new recipient',
                //     timer: 1500,
                //     showConfirmButton: false
                // });
            });

            // Track if CSV has been modified
            let csvModified = false;

            function markAsModified() {
                csvModified = true;
                $('#modifiedIndicator').show();
            }

            // Clear Duplicates Button
            $('#clearDuplicatesBtn').on('click', function() {
                rebuildEmailCache();

                // Count duplicates before removal
                let duplicateCount = 0;
                const emailsSeen = new Set();
                const rowsToKeep = [];

                csvData.forEach(row => {
                    const emailLower = row.email ? row.email.toLowerCase() : '';
                    if (emailLower && emailsSeen.has(emailLower)) {
                        duplicateCount++;
                    } else {
                        if (emailLower) emailsSeen.add(emailLower);
                        rowsToKeep.push(row);
                    }
                });

                if (duplicateCount === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'No Duplicates',
                        text: 'No duplicate email addresses found',
                        timer: 2000
                    });
                    return;
                }

                Swal.fire({
                    icon: 'warning',
                    title: 'Remove Duplicates?',
                    html: `This will remove <strong>${duplicateCount}</strong> duplicate row(s).<br>Only the first occurrence of each email will be kept.`,
                    showCancelButton: true,
                    confirmButtonText: 'Yes, Remove Duplicates',
                    confirmButtonColor: '#f0ad4e'
                }).then((result) => {
                    if (result.isConfirmed) {
                        csvData = rowsToKeep;
                        markAsModified();

                        // Adjust current page if needed
                        const totalPages = Math.ceil(csvData.length / rowsPerPage);
                        if (currentPage > totalPages && totalPages > 0) {
                            currentPage = totalPages;
                        }

                        renderPreviewPage();
                        updateValidationCounts();

                        Swal.fire({
                            icon: 'success',
                            title: 'Duplicates Removed',
                            text: `Removed ${duplicateCount} duplicate row(s)`,
                            timer: 2000,
                            showConfirmButton: false
                        });
                    }
                });
            });

            // Clear Invalid Button
            $('#clearInvalidBtn').on('click', function() {
                const validTicketTypes = ['visitor', 'vip', 'gold', 'platinum', 'exhibitor'];
                rebuildEmailCache();

                const validRows = csvData.filter(row => {
                    const hasValidTicketType = validTicketTypes.includes(row.ticketType);
                    const hasValidEmail = row.email && validateEmail(row.email);
                    const isDuplicate = checkDuplicateEmail(row.index, row.email);
                    return row.name && hasValidEmail && hasValidTicketType && !isDuplicate;
                });

                const invalidCount = csvData.length - validRows.length;

                if (invalidCount === 0) {
                    Swal.fire({
                        icon: 'info',
                        title: 'No Invalid Rows',
                        text: 'All rows are valid',
                        timer: 2000
                    });
                    return;
                }

                Swal.fire({
                    icon: 'warning',
                    title: 'Remove Invalid Rows?',
                    html: `This will remove <strong>${invalidCount}</strong> invalid row(s).<br>Invalid rows include those with missing data, invalid emails, invalid ticket types, or duplicates.`,
                    showCancelButton: true,
                    confirmButtonText: 'Yes, Remove Invalid',
                    confirmButtonColor: '#f0ad4e'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // DEBUG: Before clearing invalid
                        console.log('=== CLEAR INVALID DEBUG ===');
                        console.log('Before - Total rows:', csvData.length);
                        console.log('Before - Valid rows:', validRows.length);
                        console.log('Before - Invalid count:', invalidCount);

                        csvData = validRows;
                        markAsModified();

                        console.log('After - csvData length:', csvData.length);
                        console.log('After - First 3 rows:', csvData.slice(0, 3));

                        // Adjust current page if needed
                        const totalPages = Math.ceil(csvData.length / rowsPerPage);
                        if (currentPage > totalPages && totalPages > 0) {
                            currentPage = totalPages;
                        }

                        renderPreviewPage();
                        updateValidationCounts();

                        Swal.fire({
                            icon: 'success',
                            title: 'Invalid Rows Removed',
                            text: `Removed ${invalidCount} invalid row(s). ${validRows.length} valid row(s) remaining.`,
                            timer: 2500,
                            showConfirmButton: false
                        });
                    }
                });
            });

            // Download Modified CSV
            $('#downloadCsvBtn').on('click', function() {
                if (csvData.length === 0) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'No Data',
                        text: 'No data to download',
                        timer: 2000
                    });
                    return;
                }

                // Build CSV content
                let csvContent = 'Full Name,Email,Ticket Type,Company Name,Personal Message\n';

                csvData.forEach(row => {
                    // Escape fields that contain commas or quotes
                    const escapeCsvField = (field) => {
                        if (!field) return '';
                        const str = String(field);
                        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                            return `"${str.replace(/"/g, '""')}"`;
                        }
                        return str;
                    };

                    csvContent += `${escapeCsvField(row.name)},${escapeCsvField(row.email)},${escapeCsvField(row.ticketType)},${escapeCsvField(row.company)},${escapeCsvField(row.message || '')}\n`;
                });

                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;

                // Generate filename with timestamp
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = csvModified
                    ? `modified_invitations_${timestamp}.csv`
                    : `invitations_${timestamp}.csv`;

                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                Swal.fire({
                    icon: 'success',
                    title: 'CSV Downloaded',
                    text: `Downloaded ${csvData.length} row(s)`,
                    timer: 2000,
                    showConfirmButton: false
                });
            });

            // Download CSV Template
            $('#downloadTemplateBtn').on('click', function() {
                const csvContent = 'Full Name,Email,Ticket Type,Company Name,Personal Message\nJohn Doe,john@example.com,visitor,ABC Corp,Looking forward to seeing you\nJane Smith,jane@example.com,vip,XYZ Inc,';
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bulk_invitation_template.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            });

            // Send Bulk - AJAX with FormData for file
      $('#sendBulkInviteBtn').click(function() {
    if ($('#bulkPersonalizedForm')[0].checkValidity() && csvData.length > 0) {
        // DEBUG: Check csvData before filtering
        console.log('=== SUBMIT DEBUG ===');
        console.log('Total csvData rows:', csvData.length);
        console.log('First 3 rows of csvData:', csvData.slice(0, 3));
        console.log('Last 3 rows of csvData:', csvData.slice(-3));

        const validRows = csvData.filter(row =>
            row.name && row.email && validateEmail(row.email) && row.ticketType
        );

        console.log('Valid rows after filter:', validRows.length);
        console.log('First 3 valid rows:', validRows.slice(0, 3));

        if (validRows.length === 0) {
            Swal.fire('Error', 'No valid rows to send', 'error');
            return;
        }

        // ✅ CHECK FOR DUPLICATE EMAILS
        const emailSet = new Set();
        const duplicates = [];
        validRows.forEach(row => {
            if (emailSet.has(row.email.toLowerCase())) {
                duplicates.push(row.email);
            } else {
                emailSet.add(row.email.toLowerCase());
            }
        });

        if (duplicates.length > 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Duplicate Emails Found',
                html: `There are <strong>${duplicates.length}</strong> duplicate email(s) in the file.<br><br>Do you want to continue?`,
                showCancelButton: true,
                confirmButtonText: 'Yes, Continue',
                cancelButtonText: 'No, Fix It'
            }).then((result) => {
                if (!result.isConfirmed) {
                    return;
                }
                proceedWithSend(validRows);
            });
        } else {
            proceedWithSend(validRows);
        }
    } else {
        $('#bulkPersonalizedForm')[0].reportValidity();
    }
});

// ✅ SEPARATE FUNCTION TO HANDLE SENDING
function proceedWithSend(validRows) {
    Swal.fire({
        icon: 'question',
        title: 'Send Bulk Invitations',
        html: `Send to <strong>${validRows.length}</strong> valid recipients?`,
        showCancelButton: true,
        confirmButtonText: 'Send All'
    }).then((result) => {
        if (result.isConfirmed) {
            const formData = new FormData();

            // ✅ REGENERATE CSV FROM csvData (includes added/edited rows)
            const csvContent = generateCSVFromData(validRows);
            console.log('Generated CSV Content:', csvContent);
            console.log('CSV Length:', csvContent.length);
            console.log('Valid Rows Count:', validRows.length);

            const csvBlob = new Blob([csvContent], { type: 'text/csv' });
            const csvFile = new File([csvBlob], 'bulk_invitations.csv', { type: 'text/csv' });

            console.log('CSV File Size:', csvFile.size);

            const maxFileSizeMB = 1;
            const maxFileSizeBytes = maxFileSizeMB * 1024 * 1024;
            const fileSize = csvFile.size;

            formData.append('bulkCsvFile', csvFile);
            formData.append('isLargeFile', fileSize > maxFileSizeBytes ? 'true' : 'false');
            formData.append('bulkPersonalMessage', $('#bulkPersonalMessage').val());
            formData.append('bulkExpireDate', $('#bulkExpireDate').val());

            // Debug FormData
            console.log('FormData entries:');
            for (let pair of formData.entries()) {
                console.log(pair[0], pair[1]);
            }
            
            $.ajax({
                url: '{% url "invitations:send_bulk_personalized_invitation" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        $('#bulkPersonalizedModal').modal('hide');
                        Swal.fire({
                            icon: 'success',
                            title: 'Bulk Sent!',
                            html: `${response.valid_count} invitations sent. ${response.error_count} errors.<br>${response.errors.join('<br>') || 'No errors'}`,
                            timer: 5000
                        });
                        $('#bulkPersonalizedForm')[0].reset();
                        $('#csvPreviewSection').hide();
                        csvData = [];
                        location.reload();
                    } else {
                        Swal.fire('Error', response.error, 'error');
                    }
                },
                error: function(res) {
                    const errorMessage = res.responseJSON && res.responseJSON.error 
                        ? res.responseJSON.error 
                        : 'An unknown error occurred';
                    Swal.fire('Error', `Failed to send bulk invitations: ${errorMessage}`, 'error');
                }
            });
        }
    });
}

// ✅ FUNCTION TO GENERATE CSV FROM csvData ARRAY
function generateCSVFromData(rows) {
    const headers = ['Full Name', 'Email', 'Ticket Type', 'Company Name', 'Personal Message'];
    let csvContent = headers.join(',') + '\n';
    
    rows.forEach(row => {
        const line = [
            escapeCSVField(row.name),
            escapeCSVField(row.email),
            escapeCSVField(row.ticketType),
            escapeCSVField(row.company),
            escapeCSVField(row.message)
        ].join(',');
        csvContent += line + '\n';
    });
    
    return csvContent;
}

// ✅ ESCAPE CSV FIELDS (handle commas, quotes, newlines)
function escapeCSVField(field) {
    if (field === null || field === undefined) {
        return '';
    }
    
    const stringField = String(field);
    
    // If field contains comma, quote, or newline, wrap in quotes and escape quotes
    if (stringField.includes(',') || stringField.includes('"') || stringField.includes('\n')) {
        return '"' + stringField.replace(/"/g, '""') + '"';
    }
    
    return stringField;
}

            // Initialize DataTable
            const table = $('#invitationTable').DataTable({
                pageLength: 10,
                responsive: true,
                order: [[1, 'desc']],
                dom: '<"row"<"col-sm-12 col-md-6"l><"col-sm-12 col-md-6"f>>rtip',
                language: {
                    lengthMenu: "Show _MENU_ entries",
                    search: "Search:",
                    info: "Showing _START_ to _END_ of _TOTAL_ entries",
                    paginate: {
                        first: "First",
                        last: "Last",
                        next: "Next",
                        previous: "Previous"
                    }
                },
                columnDefs: [
                    { orderable: false, targets: [0, 9] },
                    { className: 'text-center', targets: [0] }
                ],
                ajax: {
                    url: '{% url "invitations:invitation_list" %}',  // Add URL for list view
                    dataSrc: 'data'
                },
                columns: [
                    {
                        data: null,
                        render: function(data, type, row, meta) {
                            return `<input type="checkbox" class="table-checkbox row-checkbox" data-id="${meta.row}">`;
                        }
                    },
                    { data: 'name' },
                    { data: 'email' },
                    { data: 'type' },
                    { data: 'expiry' },
                    { data: 'limit' },
                    { data: 'registered' },
                    { 
                        data: null,
                        render: function() {
                            return '<button class="btn btn-sm btn-primary copy-link"><i class="fas fa-copy me-1"></i>Copy Link</button>';
                        }
                    },
                  {
                    data: 'status',
                    render: function(data) {
                        const statusClass = data === 'Active' ? 'success' :     
                                        data === 'Expired' ? 'danger' : 'secondary';
                        return `<span class="badge bg-${statusClass}">${data}</span>`;
                    }
                },
                    {
                        data: 'type',
                        render: function(data) {

                            if (data === 'personalized') {

                                 return `
                                    <button class="btn btn-action btn-sm btn-info" title="View"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-action btn-sm btn-warning" title="Edit"><i class="fas fa-edit"></i></button>

                                    <button class="btn btn-action btn-sm btn-danger" title="Delete"><i class="fas fa-trash"></i></button>
                                `;

                            } else {
                                return `
                                    <button class="btn btn-action btn-sm btn-info" title="View"><i class="fas fa-eye"></i></button>
                                    <button class="btn btn-action btn-sm btn-warning" title="Edit"><i class="fas fa-edit"></i></button>
                                    <button class="btn btn-action btn-sm btn-success" title="Broadcast"><i class="fas fa-broadcast-tower"></i></button>
                                    <button class="btn btn-action btn-sm btn-danger" title="Delete"><i class="fas fa-trash"></i></button>
                                `;
                            }
                               
                        }
                    }
                ],
                
                initComplete: function() {
                    $('.dataTables_length select').addClass('form-select form-select-sm').css({
                        'width': 'auto',
                        'display': 'inline-block',
                        'margin': '0 8px'
                    });
                    
                    $('.dataTables_filter input').addClass('form-control form-control-sm').css({
                        'width': 'auto',
                        'display': 'inline-block',
                        'margin-left': '8px'
                    });
                }
            });

            // Generate Sample Data
            function generateSampleData() {
                const names = ['Annaleen Pimentel', 'John Smith', 'Sarah Johnson', 'Michael Chen', 'Emma Wilson'];
                const data = [];
                for (let i = 0; i < 50; i++) {
                    data.push({
                        name: names[Math.floor(Math.random() * names.length)] + ' - 100 links',
                        email: 'View',
                        type: 'Invitation Link',
                        expiry: '17th Oct 2025',
                        limit: Math.floor(Math.random() * 10) + 1,
                        registered: Math.floor(Math.random() * 5),
                        status: ['Active', 'Expired'][Math.floor(Math.random() * 3)]
                    });
                }
                return data;
            }

            // Checkbox Selection Logic
            let selectedRows = new Set();

            $('#selectAll').on('change', function() {
                const isChecked = $(this).prop('checked');
                $('.row-checkbox').prop('checked', isChecked);
                
                if (isChecked) {
                    $('.row-checkbox').each(function() {
                        selectedRows.add($(this).data('id'));
                        $(this).closest('tr').addClass('selected');
                    });
                } else {
                    selectedRows.clear();
                    $('tbody tr').removeClass('selected');
                }
                updateBulkActionsBar();
            });

            $(document).on('change', '.row-checkbox', function() {
                const rowId = $(this).data('id');
                const isChecked = $(this).prop('checked');
                
                if (isChecked) {
                    selectedRows.add(rowId);
                    $(this).closest('tr').addClass('selected');
                } else {
                    selectedRows.delete(rowId);
                    $(this).closest('tr').removeClass('selected');
                }
                
                const totalCheckboxes = $('.row-checkbox').length;
                const checkedCheckboxes = $('.row-checkbox:checked').length;
                $('#selectAll').prop('checked', totalCheckboxes === checkedCheckboxes);
                $('#selectAll').prop('indeterminate', checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes);
                
                updateBulkActionsBar();
            });

            function updateBulkActionsBar() {
                const count = selectedRows.size;
                if (count > 0) {
                    $('#bulkActionsBar').addClass('show');
                    $('#selectedCount').text(count);
                } else {
                    $('#bulkActionsBar').removeClass('show');
                }
            }

            $('#clearSelectionBtn').click(function() {
                selectedRows.clear();
                $('.row-checkbox, #selectAll').prop('checked', false);
                $('tbody tr').removeClass('selected');
                updateBulkActionsBar();
            });

            $('#bulkSendBtn').click(function() {
                Swal.fire({
                    icon: 'info',
                    title: 'Send Invitations',
                    text: `Send invitations to ${selectedRows.size} selected items?`,
                    showCancelButton: true,
                    confirmButtonText: 'Send All'
                }).then((result) => {
                    if (result.isConfirmed) {
                        showLoading();
                        const formData = {
                            SelectedIds: Array.from(selectedRows),
                        };

                        console.log('Activating IDs:', formData.SelectedIds);
        
                        $.ajax({
                            url: `/send-bulk-invites/`,
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(formData),
                            headers: {
                                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            success: function(response) {
                                 Swal.fire('Activated!', `${selectedRows.size} invites send.`, 'success');
                                 $('#clearSelectionBtn').click();
                                 hideLoading();
                            },
                            error: function(res) {
                                const errorMessage = res.responseJSON && res.responseJSON.error 
                                    ? res.responseJSON.error 
                                    : 'Failed to update Activate status for selected items.';
                                Swal.fire('Error', errorMessage, 'error');
                            }
                        });;
                    }
                });
            });

            $('#bulkActivateBtn').click(function() {
                Swal.fire({
                    icon: 'question',
                    title: 'Activate Selected',
                    text: `Activate ${selectedRows.size} selected items?`,
                    showCancelButton: true,
                    confirmButtonText: 'Activate'
                }).then((result) => {
                    if (result.isConfirmed) {

                        const formData = {
                            SelectedIds: Array.from(selectedRows),
                        };

                        console.log('Activating IDs:', formData.SelectedIds);
        
                        $.ajax({
                            url: `/bulk-activate/`,
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(formData),
                            headers: {
                                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            success: function(response) {
                                 Swal.fire('Activated!', `${selectedRows.size} items have been activated.`, 'success');
                                 $('#clearSelectionBtn').click();
                                 hideLoading();
                            },
                            error: function(res) {
                                const errorMessage = res.responseJSON && res.responseJSON.error 
                                    ? res.responseJSON.error 
                                    : 'Failed to send invites for selected items.';
                                Swal.fire('Error', errorMessage, 'error');
                            }
                        });


                      
                    }
                });
            });

            $('#bulkDeactivateBtn').click(function() {
                Swal.fire({
                    icon: 'warning',
                    title: 'Deactivate Selected',
                    text: `Deactivate ${selectedRows.size} selected items?`,
                    showCancelButton: true,
                    confirmButtonText: 'Deactivate'
                }).then((result) => {
                    if (result.isConfirmed) {
                        const formData = {
                            SelectedIds: Array.from(selectedRows),
                        };

                        console.log('Activating IDs:', formData.SelectedIds);
        
                        $.ajax({
                            url: `/bulk-deactivate/`,
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(formData),
                            headers: {
                                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            success: function(response) {
                                 Swal.fire('Deactivated!', `${selectedRows.size} items have been deactivated.`, 'success');
                                 $('#clearSelectionBtn').click();
                                 hideLoading();
                            },
                            error: function(res) {
                                const errorMessage = res.responseJSON && res.responseJSON.error 
                                    ? res.responseJSON.error 
                                    : 'Failed to update De-Activate status for selected items.';
                                Swal.fire('Error', errorMessage, 'error');
                            }
                        });

                        
                    }
                });
            });

            $('#bulkExportBtn').click(function() {
                showLoading();
                setTimeout(() => {
                    hideLoading();
                    Swal.fire('Exported!', `${selectedRows.size} items have been exported to Excel.`, 'success');
                }, 1000);
            });

            $('#bulkDeleteBtn').click(function() {
                Swal.fire({
                    icon: 'error',
                    title: 'Delete Selected',
                    text: `Are you sure you want to delete ${selectedRows.size} selected items?`,
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Delete All'
                }).then((result) => {
                    if (result.isConfirmed) {
                        showLoading();
                
                        const formData = {
                            SelectedIds: Array.from(selectedRows),
                        };

                        console.log('Activating IDs:', formData.SelectedIds);
        
                        $.ajax({
                            url: `/bulk-delete/`,
                            type: 'POST',
                            contentType: 'application/json',
                            data: JSON.stringify(formData),
                            headers: {
                                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            success: function(response) {
                                hideLoading();
                                Swal.fire('Deleted!', `${selectedRows.size} items have been deleted.`, 'success');
                                $('#clearSelectionBtn').click();
                            },
                            error: function(res) {
                                const errorMessage = res.responseJSON && res.responseJSON.error 
                                    ? res.responseJSON.error 
                                    : 'Failed to Delete for selected items.';
                                Swal.fire('Error', errorMessage, 'error');
                            }
                        });
         
                    }
                });
            });

            $('#sidebarToggle').click(function() {
                $('#sidebar').toggleClass('show');
            });

            $('.nav-item').click(function(e) {
                e.preventDefault();
                $('.nav-item').removeClass('active');
                $(this).addClass('active');
            });

              // ⏱️ Countdown Timer (unchanged)
    function updateCountdown() {
        const countdown = $('#countdown');
        let days = 16, hours = 17, minutes = 45, seconds = 19;
        
        setInterval(function() {
            seconds--;
            if (seconds < 0) {
                seconds = 59;
                minutes--;
                if (minutes < 0) {
                    minutes = 59;
                    hours--;
                    if (hours < 0) {
                        hours = 23;
                        days--;
                    }
                }
            }
            
            countdown.html(`
                <span>${days}<small>Days</small></span>
                <span>${hours}<small>Hours</small></span>
                <span>${minutes}<small>Mins</small></span>
                <span>${seconds}<small>Secs</small></span>
            `);
        }, 1000);
    }
    updateCountdown();


    // 🟡 Reusable counter animation function ✅ NEW
    function animateCounter($el, newCount) {
        // Update data-count attribute to new value
        $el.attr('data-count', newCount);

        // Animate from 0 to newCount
        $({ countNum: 0 }).animate({ countNum: newCount }, {
            duration: 1500,
            easing: 'swing',
            step: function() {
                $el.text(Math.floor(this.countNum));
            },
            complete: function() {
                $el.text(this.countNum);
            }
        });
    }

    // // 🚀 Initial animation for all stat values (on page load)
    $('.stat-value').each(function() {
        const $this = $(this);
        const countTo = parseInt($this.attr('data-count'), 10) || 0;
        
        // Show the value immediately
        $this.text(countTo);
        
        // Optional: Animate from 0 for visual effect
        $({ countNum: 0 }).animate({ countNum: countTo }, {
            duration: 1500,
            easing: 'swing',
            step: function() {
                $this.text(Math.floor(this.countNum));
            },
            complete: function() {
                $this.text(countTo);
            }
        });
    });

    // 🌐 Example: Refresh table and update registered visitors count dynamically
    $('#refreshTable').on('click', function() {
        $.ajax({
            url: "{% url 'invitations:invitation_list' %}",  // make sure this is the correct URL for your AJAX view
            type: "GET",
            dataType: "json",
            headers: {
                "X-Requested-With": "XMLHttpRequest"
            },
            success: function(response) {
                // ✅ Update DataTables or table rows here as needed...
                // For example:
                // table.clear().rows.add(response.data).draw();

                // ✅ If your Django view returns 'registered_visitors', update it dynamically
                if (response.registered_visitors !== undefined) {
                    const $registered = $('#registeredVisitorsCount');
                    animateCounter($registered, parseInt(response.registered_visitors, 10) || 0);
                }
            },
            error: function(xhr, status, error) {
                console.error("Failed to refresh invitations:", error);
            }
        });
    });

           $(document).on('click', '.copy-link', function() {
                const rowData = table.row($(this).parents('tr')).data();
                const invitationKey = rowData.key;

                // 👉 Use dynamic domain instead of hardcoded localhost
                const invitationBaseUrl = window.location.origin + '/';
                const inviteUrl = `${invitationBaseUrl}invite/${invitationKey}`;

                const btn = $(this);
                const originalHtml = btn.html();

                // --- Helper fallback function for insecure (HTTP) contexts ---
                function fallbackCopyTextToClipboard(text) {
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";  // avoid scrolling
                    textArea.style.opacity = "0";
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();

                    try {
                        document.execCommand('copy');
                    } catch (err) {
                        console.error('Fallback: unable to copy', err);
                    }

                    document.body.removeChild(textArea);
                }

                //line added for checking github

                // --- Main copy logic with HTTPS check ---
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(inviteUrl)
                        .then(() => showCopiedState())
                        .catch(err => {
                            console.warn('Clipboard API failed, using fallback:', err);
                            fallbackCopyTextToClipboard(inviteUrl);
                            showCopiedState();
                        });
                } else {
                    fallbackCopyTextToClipboard(inviteUrl);
                    showCopiedState();
                }

                // --- Button UI feedback ---
                function showCopiedState() {
                    btn.html('<i class="fas fa-check me-1"></i>Copied!')
                        .addClass('btn-success')
                        .removeClass('btn-primary');

                    setTimeout(() => {
                        btn.html(originalHtml)
                            .addClass('btn-primary')
                            .removeClass('btn-success');
                    }, 2000);
                }
            });

                        $('#searchBtn').click(function() {
                            showLoading();
                            setTimeout(() => {
                                const keyword = $('#searchKeyword').val();
                                table.search(keyword).draw();
                                hideLoading();
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Search Complete',
                                    text: `Found ${table.page.info().recordsDisplay} results`,
                                    timer: 1500,
                                    showConfirmButton: false
                                });
                            }, 500);
                        });

             $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                // Get filter values
                const filterStatus = $('#filterStatus').val().toLowerCase();
                const filterType = $('#filterType').val().toLowerCase();
                const filterDate = $('#filterDate').val();
                
                // Get row data
                const rowStatus = data[8].toLowerCase(); // Status column (raw status, e.g., 'Pending' -> 'pending')
                const rowType = data[3].toLowerCase();
                const rowExpiry = data[4]; // Expiry column
                
                // Status filter
               if (filterStatus && rowStatus !== filterStatus) {
                    return false;
                }
                
                // Type filter
                if (filterType) {
                    if (filterType === 'link' && !rowType.includes('invitation link')) {
                        return false;
                    }
                    if (filterType === 'personal' && !rowType.includes('personal')) {
                        return false;
                    }
                }
                
                // Date filter
                if (filterDate && rowExpiry !== 'N/A') {
                    // Parse the date from format like "17th Oct 2025"
                    const rowDate = new Date(rowExpiry);
                    const selectedDate = new Date(filterDate);
                    
                    // Compare dates (ignore time)
                    if (rowDate.toDateString() !== selectedDate.toDateString()) {
                        return false;
                    }
                }
                
                return true;
            });

            // Apply filters on change
            $('#filterStatus, #filterType, #filterDate').on('change', function() {
                table.draw();
            });

            $('#searchKeyword').on('input', function() {
                table.search($(this).val()).draw();
            });

            $('#resetBtn').click(function() {
                $('#searchKeyword').val('');
                $('#filterStatus').val('').trigger('change');
                $('#filterType').val('').trigger('change');
                $('#filterDate').val('');
                table.search('').draw();
            });

          $('#exportBtn').click(function() {
            Swal.fire({
                title: 'Export Data',
                text: 'Select export format',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Excel',
                cancelButtonText: 'CSV',
                showDenyButton: true,
                denyButtonText: 'PDF'
            }).then((result) => {
            
                if (result.isConfirmed || result.isDenied || result.dismiss === Swal.DismissReason.cancel) {
                   
                   
                const format = result.isConfirmed ? 'excel' : result.isDenied ? 'pdf' : 'csv';
            
          
         
            // Create FormData object
            const formData = new FormData();
            formData.append('format', format);
            
            
            // Start Celery task
            fetch("{% url 'invitations:export_invitations' %}", {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                    body: formData
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to start export');
                    return response.json();
                })
                .then(data => {
                    const jobId = data.job_id;
                    Swal.fire({
                        icon: 'info',
                        title: 'Export in Progress',
                        text: 'This may take a moment. You will be notified when it is ready.',
                        allowOutsideClick: false,
                        didOpen: () => {
                            Swal.showLoading();
                        }
                    });
                    // Redirect to jobs list or start polling
                    setTimeout(() => {
                        window.location.href = `/exports-jobs?highlight=${jobId}`;
                    }, 2000);
                })
                .catch(error => {
                    Swal.fire('Error', 'Failed to start export: ' + error.message, 'error');
                });
            }
        });
    });

            $('#submitLinkBtn').click(function() {
    if ($('#generateLinkForm')[0].checkValidity()) {
        const selectedDate = $('#expireDate').val();
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (new Date(selectedDate) < today) {
            console.log('Invalid date');
            Swal.fire('Invalid Date', "You can't choose an expired date.", 'error');
            return;
        }

        const formData = {
            linkTitle: $('#linkTitle').val(),
            linkLimit: $('#linkLimit').val(),
            linkCount: $('#linkCount').val(),
            TicketType: $('#linkTicketType').val().toLowerCase(),
            expireDate: $('#expireDate').val()
        };
        
        $.ajax({
            url: '{% url "invitations:send_private_invitation" %}',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    $('#generateLinkModal').modal('hide');
                    
                    // Build HTML for multiple links
                    let linksHtml = '<div class="links-container" style="max-height: 400px; overflow-y: auto;">';
                    
                    response.links.forEach((link, index) => {
                        linksHtml += `
                            <div class="mb-3">
                                <label class="form-label fw-bold">Link ${index + 1}:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control link-input" value="${link.url}" readonly>
                                    <button class="btn btn-primary copy-btn" data-link="${link.url}">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                    
                    linksHtml += '</div>';
                    
                    // Add "Copy All" button if multiple links
                    if (response.links.length > 1) {
                        const allLinks = response.links.map(l => l.url).join('\n');
                        linksHtml += `
                            <div class="mt-3">
                                <button class="btn btn-success w-100" id="copyAllLinks" data-links="${allLinks.replace(/"/g, '&quot;')}">
                                    <i class="fas fa-copy me-2"></i>Copy All Links
                                </button>
                            </div>
                        `;
                    }
                    
                    Swal.fire({
                        icon: 'success',
                        title: 'Links Generated!',
                        html: `
                            <p class="mb-3">${response.total_count} invitation link(s) have been created:</p>
                            ${linksHtml}
                        `,
                        width: '600px',
                        confirmButtonText: 'Done',
                        didOpen: () => {
                            // Handle individual copy buttons
                            document.querySelectorAll('.copy-btn').forEach(btn => {
                                btn.addEventListener('click', function() {
                                    const link = this.getAttribute('data-link');
                                    navigator.clipboard.writeText(link).then(() => {
                                        const icon = this.querySelector('i');
                                        icon.className = 'fas fa-check';
                                        setTimeout(() => {
                                            icon.className = 'fas fa-copy';
                                        }, 2000);
                                    });
                                });
                            });
                            
                            // Handle copy all button
                            const copyAllBtn = document.getElementById('copyAllLinks');
                            if (copyAllBtn) {
                                copyAllBtn.addEventListener('click', function() {
                                    const links = this.getAttribute('data-links').replace(/&quot;/g, '"');
                                    navigator.clipboard.writeText(links).then(() => {
                                        this.innerHTML = '<i class="fas fa-check me-2"></i>Copied!';
                                        setTimeout(() => {
                                            this.innerHTML = '<i class="fas fa-copy me-2"></i>Copy All Links';
                                        }, 2000);
                                    });
                                });
                            }
                        }
                    }).then(() => {
                        location.reload();
                    });
                    
                    $('#generateLinkForm')[0].reset();
                } else {
                    const errorMessage = response.error || 'An unknown error occurred';
                    Swal.fire('Error', errorMessage, 'error');
                }
            },
            error: function(res) {
                const errorMessage = res.responseJSON && res.responseJSON.error ? res.responseJSON.error : 'An unknown error occurred';
                Swal.fire('Error', errorMessage, 'error');
            }
        });
    } else {
        $('#generateLinkForm')[0].reportValidity();
    }
});


       

            // Send Single Personalized Invitation - AJAX
        $('#sendInviteBtn').click(function() {
            if ($('#personalizedForm')[0].checkValidity()) {
                const personalExpireDate = $('#personalExpireDate').val();
                const today = new Date();
          
                const formData = {
                    guestName: $('#guestName').val(),
                    guestEmail: $('#guestEmail').val(),
                    ticketType: $('#ticketType').val().toLowerCase(),
                    companyName: $('#companyName').val(),
                    personalMessage: $('#personalMessage').val(),
                    personalExpireDate: $('#personalExpireDate').val()
                };
                
                $.ajax({
                    url: '{% url "invitations:send_personalized_invitation" %}',  // Add this URL in urls.py
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    headers: {
                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()  // If using CSRF
                    },
                    success: function(response) {
                        if (response.success) {
                            $('#personalizedModal').modal('hide');
                            Swal.fire({
                                icon: 'success',
                                title: 'Invitation Sent!',
                                text: response.message,
                                footer: `<a href="${response.link}">View Link</a>`
                            });
                            $('#personalizedForm')[0].reset();
                            // Refresh table if needed
                            location.reload();  // Or ajax reload table
                        } else {
                            // Swal.fire('Error', response.error, 'error');
                            const errorMessage = response.responseJSON && response.responseJSON.error ? response.responseJSON.error : 'An unknown error occurred';
                            Swal.fire('Error', errorMessage, 'error');
                        }
                    },
                    error: function(response) {
                        const errorMessage = response.responseJSON && response.responseJSON.error ? response.responseJSON.error : 'An unknown error occurred';
                        Swal.fire('Error', errorMessage, 'error');
                        // Swal.fire('Error', 'Failed to send invitation', 'error');
                    }
                });
            } else {
                $('#personalizedForm')[0].reportValidity();
            }
            });

            $('#refreshTable').click(function() {
                $(this).find('i').addClass('fa-spin');
                setTimeout(() => {
                    table.ajax.reload();
                    $(this).find('i').removeClass('fa-spin');
                }, 1000);
            });

            $(document).on('click', '.btn-action', function() {
                const action = $(this).attr('title');
                const row = table.row($(this).parents('tr')).data();

                console.log('Action:', action, 'Row Data:', row);
                
                switch(action) {
                    case 'View':
                        $.ajax({
                            url: `/invitations/${row.id}/view/`,
                            method: 'GET',
                            success: function(data) {
                                Swal.fire('View Details', 
                                    `Name: ${data.title_or_name}<br>
                                    Email: ${data.email}<br>
                                    Type: ${data.invite_type}<br>
                                    Status: ${data.status}<br>
                                    Expiry: ${data.expiry_date}<br>
                                    Company: ${data.company_name}<br>
                                    Message: ${data.personal_message}`,
                                    'info');
                            }
                        });
                        break;
                   case 'Edit':
                        // First, fetch the invitation data to ensure we have the latest info
                        $.ajax({
                            url: `/invitations/${row.id}/get/`,
                            method: 'GET',
                            success: function(response) {
                                if (response.success) {
                                    const invitation = response.data;
                                    
                                    Swal.fire({
                                        title: 'Edit Invitation',
                                        html: `
                                            <div class="swal2-form-container">
                                                <input id="swal_title_or_name" class="swal2-input" placeholder="Title/Name" value="${invitation.title_or_name || ''}">
                                                <input id="swal_email" class="swal2-input" placeholder="Email" value="${invitation.email || ''}" readonly>
                                                <select id="swal_ticket_type" class="swal2-input">
                                                    <option value="">Select Ticket Type</option>
                                                    <option value="visitor" ${invitation.ticket_type === 'visitor' ? 'selected' : ''}>Visitor</option>
                                                    <option value="vip" ${invitation.ticket_type === 'vip' ? 'selected' : ''}>VIP</option>
                                                    <option value="gold" ${invitation.ticket_type === 'gold' ? 'selected' : ''}>Gold</option>
                                                    <option value="platinum" ${invitation.ticket_type === 'platinum' ? 'selected' : ''}>Platinum</option>
                                                    <option value="exhibitor" ${invitation.ticket_type === 'exhibitor' ? 'selected' : ''}>Exhibitor</option>
                                                </select>
                                                <select id="swal_status" class="swal2-input">
                                                    <option value="active" ${invitation.status === 'active' ? 'selected' : ''}>Active</option>
                                                    <option value="pending" ${invitation.status === 'pending' ? 'selected' : ''}>Pending</option>
                                                    <option value="expired" ${invitation.status === 'expired' ? 'selected' : ''}>Expired</option>
                                                </select>
                                                <input id="swal_expiry_date" type="date" class="swal2-input" value="${invitation.expiry_date || ''}">
                                                <input id="swal_link_limit" type="number" class="swal2-input" placeholder="Link Limit" min="1" max="100" value="${invitation.link_limit || 1}">
                                                <input id="swal_company_name" class="swal2-input" placeholder="Company Name" value="${invitation.company_name || ''}">
                                                <textarea id="swal_personal_message" class="swal2-textarea" placeholder="Personal Message">${invitation.personal_message || ''}</textarea>
                                            </div>
                                        `,
                                        width: '600px',
                                        showCancelButton: true,
                                        confirmButtonText: 'Save Changes',
                                        cancelButtonText: 'Cancel',
                                        confirmButtonColor: '#ffc107',
                                        preConfirm: () => {
                                            const expiryDate = $('#swal_expiry_date').val();
                                            const linkLimit = $('#swal_link_limit').val();
                                            const ticketType = $('#swal_ticket_type').val();
                                            
                                            // Validation
                                            if (!$('#swal_title_or_name').val()) {
                                                Swal.showValidationMessage('Title/Name is required');
                                                return false;
                                            }
                                            if (!expiryDate) {
                                                Swal.showValidationMessage('Expiry date is required');
                                                return false;
                                            }
                                            if (!ticketType) {
                                                Swal.showValidationMessage('Ticket type is required');
                                                return false;
                                            }
                                            if (!linkLimit || linkLimit < 1 || linkLimit > 100) {
                                                Swal.showValidationMessage('Link limit must be between 1 and 100');
                                                return false;
                                            }
                                            
                                            // Check if date is not in the past
                                            const selectedDate = new Date(expiryDate);
                                            const today = new Date();
                                            today.setHours(0, 0, 0, 0);
                                            
                                            if (selectedDate < today) {
                                                Swal.showValidationMessage("Expiry date cannot be in the past");
                                                return false;
                                            }
                                            
                                            return {
                                                title_or_name: $('#swal_title_or_name').val(),
                                                email: $('#swal_email').val(),
                                                ticket_type: ticketType,
                                                status: $('#swal_status').val(),
                                                expiry_date: expiryDate,
                                                link_limit: parseInt(linkLimit),
                                                company_name: $('#swal_company_name').val(),
                                                personal_message: $('#swal_personal_message').val()
                                            };
                                        }
                                    }).then((result) => {
                                        if (result.isConfirmed) {
                                            $.ajax({
                                                url: `/invitations/${row.id}/edit/`,
                                                method: 'POST',
                                                headers: {
                                                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                                                    'X-Requested-With': 'XMLHttpRequest'
                                                },
                                                contentType: 'application/json',
                                                data: JSON.stringify(result.value),
                                                success: function(response) {
                                                    if (response.success) {
                                                        Swal.fire({
                                                            icon: 'success',
                                                            title: 'Updated!',
                                                            text: response.message || 'Invitation updated successfully',
                                                            confirmButtonText: 'OK'
                                                        }).then(() => {
                                                            table.ajax.reload(null, false); // Reload without resetting pagination
                                                        });
                                                    } else {
                                                        Swal.fire('Error', response.error || 'Failed to update invitation', 'error');
                                                    }
                                                },
                                                error: function(xhr) {
                                                    const errorMsg = xhr.responseJSON && xhr.responseJSON.error 
                                                        ? xhr.responseJSON.error 
                                                        : 'Failed to update invitation';
                                                    Swal.fire('Error', errorMsg, 'error');
                                                }
                                            });
                                        }
                                    });
                                } else {
                                    Swal.fire('Error', 'Failed to load invitation data', 'error');
                                }
                            },
                            error: function() {
                                Swal.fire('Error', 'Failed to load invitation data', 'error');
                            }
                        });
                        break;
                    case 'Broadcast':
            
                      Swal.fire({
                            title: 'Broadcasting invitation link...',
                            html: `
                                <div class="swal2-form-container">
                                    <input id="swal_email" class="swal2-input" placeholder="Email">
                                    <textarea id="swal_personal_message" class="swal2-textarea" placeholder="Personal Message"></textarea>
                                </div>
                            `,
                            width: '600px',
                            showCancelButton: true,
                            confirmButtonText: 'Save Changes',
                            cancelButtonText: 'Cancel',
                            confirmButtonColor: '#ffc107',
                            preConfirm: () => {
                            
                                
                                return {
                                    email: $('#swal_email').val(),
                                    personal_message: $('#swal_personal_message').val()
                                };
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $.ajax({
                                    url: `/send-broadcast/${row.id}/`,
                                    method: 'POST',
                                    headers: {
                                        'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                                        'X-Requested-With': 'XMLHttpRequest'
                                    },
                                    contentType: 'application/json',
                                    data: JSON.stringify(result.value),
                                    success: function(response) {
                                        if (response.success) {
                                            Swal.fire({
                                                icon: 'success',
                                                title: 'Send',
                                                text: response.message || 'Broadcast successfully send',
                                                confirmButtonText: 'OK'
                                            }).then(() => {
                                                table.ajax.reload(null, false); // Reload without resetting pagination
                                            });
                                        } else {
                                            Swal.fire('Error', response.error || 'Failed to send Broadcast', 'error');
                                        }
                                    },
                                    error: function(xhr) {
                                        const errorMsg = xhr.responseJSON && xhr.responseJSON.error 
                                            ? xhr.responseJSON.error 
                                            : 'Failed to update invitation';
                                        Swal.fire('Error', errorMsg, 'error');
                                    }
                                });
                            }
                            });

                        break;
                    case 'Delete':
                         Swal.fire({
                            title: 'Are you sure?',
                            text: "You won't be able to revert this!",
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonColor: '#d33',
                            cancelButtonColor: '#3085d6',
                            confirmButtonText: 'Yes, delete it!'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                $.ajax({
                                    url: `/invitations/${row.id}/delete/`,
                                    method: 'POST',
                                    headers: {'X-CSRFToken': '{{ csrf_token }}'},
                                    success: function(response) {
                                        Swal.fire('Deleted!', response.message, 'success');
                                        table.ajax.reload();
                                    },
                                    error: function() {
                                        Swal.fire('Error', 'Failed to delete invitation', 'error');
                                    }
                                });
                            }
                        });
                        break;
                }
            });

            function showLoading() {
                $('#loadingOverlay').addClass('show');
            }

            function hideLoading() {
                $('#loadingOverlay').removeClass('show');
            }

            $('[title]').tooltip();

            const today = new Date();
            const futureDate = new Date(today.setMonth(today.getMonth() + 1));
            $('#expireDate, #personalExpireDate').val(futureDate.toISOString().split('T')[0]);
        });




        // Function to open edit modal with invitation data
function openEditModal(invitationId) {
    // Fetch invitation data via AJAX
    $.ajax({
        url: `/invitations/${invitationId}/get/`,  // You'll need to create this endpoint
        type: 'GET',
        success: function(response) {
            if (response.success) {
                const invitation = response.data;
                
                // Populate form fields
                $('#editInvitationId').val(invitation.id);
                $('#editGuestName').val(invitation.title_or_name || '');
                $('#editGuestEmail').val(invitation.email || '');
                $('#editTicketType').val(invitation.ticket_type || '').trigger('change');
                $('#editCompanyName').val(invitation.company_name || '');
                $('#editPersonalMessage').val(invitation.personal_message || '');
                $('#editExpireDate').val(invitation.expiry_date || '');
                $('#editLinkLimit').val(invitation.link_limit || 1);
                $('#editStatus').val(invitation.status || 'active').trigger('change');
                
                // Show modal
                $('#editInvitationModal').modal('show');
            } else {
                Swal.fire('Error', 'Failed to load invitation data', 'error');
            }
        },
        error: function() {
            Swal.fire('Error', 'Failed to load invitation data', 'error');
        }
    });
}

// Attach to edit buttons (adjust selector based on your table structure)
$(document).on('click', '.edit-invitation-btn', function() {
    const invitationId = $(this).data('invitation-id');
    openEditModal(invitationId);
});

// Handle save button click
$('#saveEditBtn').click(function() {
    if ($('#editInvitationForm')[0].checkValidity()) {
        const invitationId = $('#editInvitationId').val();
        
        const formData = {
            title_or_name: $('#editGuestName').val(),
            email: $('#editGuestEmail').val(),
            ticket_type: $('#editTicketType').val(),
            company_name: $('#editCompanyName').val(),
            personal_message: $('#editPersonalMessage').val(),
            expiry_date: $('#editExpireDate').val(),
            link_limit: $('#editLinkLimit').val(),
            status: $('#editStatus').val()
        };
        
        $.ajax({
            url: `/invitations/${invitationId}/edit/`,
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                $('#editInvitationModal').modal('hide');
                Swal.fire({
                    icon: 'success',
                    title: 'Updated!',
                    text: 'Invitation has been updated successfully',
                    confirmButtonText: 'OK'
                }).then(() => {
                    location.reload();
                });
            },
            error: function(res) {
                const errorMessage = res.responseJSON && res.responseJSON.error 
                    ? res.responseJSON.error 
                    : 'Failed to update invitation';
                Swal.fire('Error', errorMessage, 'error');
            }
        });
    } else {
        $('#editInvitationForm')[0].reportValidity();
    }
});



// Check for duplicate emails in preview
function checkDuplicateEmail(index, email) {
    if (!email || !csvData || !Array.isArray(csvData)) return false;
    
    const normalizedEmail = email.toLowerCase().trim();
    let isDuplicate = false;
    
    // Check against other rows in csvData
    csvData.forEach(row => {
        if (row.index !== index && row.email.toLowerCase().trim() === normalizedEmail) {
            isDuplicate = true;
        }
    });
    
    return isDuplicate;
}

//Check email exists in database
function checkEmailInDatabase(email) {
    return new Promise((resolve, reject) => {
        $.ajax({
            url: '/check-email-exists/',  // You'll need to create this endpoint
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ email: email }),
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                resolve(response.exists);
            },
            error: function() {
                resolve(false); // On error, assume not duplicate
            }
        });
    });
}
        


    </script>
{% endblock %}